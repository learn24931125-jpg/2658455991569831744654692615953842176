<H1>智慧旅遊導覽</H1>
async function generateTrip() {
    const key = document.getElementById('apiKey').value;
    const dest = document.getElementById('destination').value;
    const btn = document.getElementById('btn');
    
    if (!dest) return alert("請輸入目的地！");

    btn.disabled = true;
    btn.innerText = "AI 正在計算路線...";

    // 定義可能的模型名稱順序，解決 404 問題
    const modelOptions = [
        "gemini-1.5-flash",
        "gemini-1.5-flash-latest",
        "gemini-pro"
    ];

    let success = false;
    let errorMessage = "";

    for (let modelName of modelOptions) {
        if (success) break;
        
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`;
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: `你是一位專業導遊。請以 JSON 格式規劃台灣「${dest}」。格式：[{"name":"名稱","lat":25.0,"lng":121.5,"desc":"簡介"}]` }] }] })
            });

            const data = await response.json();
            
            if (response.ok && data.candidates) {
                let rawText = data.candidates[0].content.parts[0].text;
                const cleanJson = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                const locations = JSON.parse(cleanJson);
                renderMapAndList(locations);
                success = true;
                console.log(`使用模型成功: ${modelName}`);
            } else {
                errorMessage = data.error?.message || "未知錯誤";
                console.warn(`模型 ${modelName} 嘗試失敗: ${errorMessage}`);
            }
        } catch (error) {
            errorMessage = error.message;
        }
    }

    if (!success) {
        alert("所有模型皆無法調用，請確認您在 Google AI Studio 介面左側是否有看到 gemini-1.5-flash 模型可選。錯誤訊息：" + errorMessage);
    }

    btn.disabled = false;
    btn.innerText = "開始生成 AI 行程";
}
