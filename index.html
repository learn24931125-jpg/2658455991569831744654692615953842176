<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI æ—…éŠè¦ç•«ç³»çµ± - ä¿®æ­£ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 500px; width: 100%; border-radius: 12px; }
        .marker-index { background: #e11d48; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; }
    </style>
</head>
<body class="bg-slate-50 p-6">

    <div class="max-w-5xl mx-auto space-y-6">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h1 class="text-2xl font-bold mb-4 text-slate-800">ğŸ“ å°ç£ AI è¡Œç¨‹è¦ç•«</h1>
            <div class="flex gap-3">
                <input type="text" id="destination" placeholder="ä¾‹å¦‚ï¼šå°å—ç¾é£Ÿä¸€æ—¥éŠ" class="flex-1 border p-3 rounded-xl outline-none focus:ring-2 focus:ring-rose-500">
                <button id="generateBtn" class="bg-rose-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-rose-600 transition">ç”Ÿæˆè¡Œç¨‹</button>
            </div>
            <input type="hidden" id="apiKey" value="AIzaSyD1wo67sEiVujXhIRtGTJ3l2WyipxTImwk">
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="itinerary" class="lg:col-span-1 space-y-3 hidden h-[500px] overflow-y-auto"></div>
            <div class="lg:col-span-2">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–åœ°åœ–
        const map = L.map('map').setView([23.5, 121], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let markers = L.layerGroup().addTo(map);
        let routeLine = null;

        // ä½¿ç”¨ addEventListener é¿å… HTML onclick æ‰¾ä¸åˆ°å‡½æ•¸çš„å•é¡Œ
        document.getElementById('generateBtn').addEventListener('click', async function() {
            const key = document.getElementById('apiKey').value;
            const dest = document.getElementById('destination').value;
            const btn = this;

            if (!dest) return alert("è«‹è¼¸å…¥ç›®çš„åœ°");

            btn.disabled = true;
            btn.innerText = "è¦åŠƒä¸­...";

            // ä½¿ç”¨ v1beta ç«¯é»èˆ‡æ­£ç¢ºçš„æ¨¡å‹è·¯å¾‘
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `ä½ æ˜¯ä¸€ä½å°ç£å°éŠã€‚è«‹è¦åŠƒã€Œ${dest}ã€ã€‚è«‹åš´æ ¼å›å‚³ JSON é™£åˆ—æ ¼å¼ï¼Œä¸è¦åŒ…å« Markdown æ¨™ç±¤ã€‚æ ¼å¼ï¼š[{"name":"æ™¯é»åç¨±","lat":ç·¯åº¦,"lng":ç¶“åº¦,"desc":"ç°¡ä»‹"}]` }] }]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || "API è«‹æ±‚å¤±æ•—");
                }

                let text = data.candidates[0].content.parts[0].text;
                // æ¸…ç† AI å¯èƒ½é™„å¸¶çš„ Markdown èªæ³•
                text = text.replace(/```json/g, "").replace(/```/g, "").trim();
                
                const locations = JSON.parse(text);
                renderMap(locations);

            } catch (error) {
                console.error(error);
                alert("éŒ¯èª¤ï¼š" + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆè¡Œç¨‹";
            }
        });

        function renderMap(locations) {
            markers.clearLayers();
            if (routeLine) map.removeLayer(routeLine);
            const listContainer = document.getElementById('itinerary');
            listContainer.innerHTML = "";
            listContainer.classList.remove('hidden');

            const latlngs = [];
            const bounds = L.latLngBounds();

            locations.forEach((loc, i) => {
                const pos = [loc.lat, loc.lng];
                latlngs.push(pos);
                bounds.extend(pos);

                // æ·»åŠ åœ°åœ–æ¨™è¨˜
                L.marker(pos, {
                    icon: L.divIcon({ className: '', html: `<div class="marker-index">${i+1}</div>`, iconSize: [24, 24] })
                }).bindPopup(`<b>${loc.name}</b><br>${loc.desc}`).addTo(markers);

                // æ·»åŠ å´é‚Šåˆ—è¡¨
                const item = document.createElement('div');
                item.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 cursor-pointer hover:bg-slate-50 transition";
                item.innerHTML = `<h3 class="font-bold text-slate-800">${i+1}. ${loc.name}</h3><p class="text-xs text-slate-500 mt-1">${loc.desc}</p>`;
                item.onclick = () => map.flyTo(pos, 15);
                listContainer.appendChild(item);
            });

            // ç•«å‡ºé€£ç·š
            routeLine = L.polyline(latlngs, { color: '#e11d48', weight: 3, dashArray: '5, 10' }).addTo(map);
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    </script>
</body>
</html>
