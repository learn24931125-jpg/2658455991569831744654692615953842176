<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°ç£æ™ºæ…§æ—…éŠå°è¦½ç³»çµ±</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f8f9fa;
        }

        body, html {
            height: 100%;
            margin: 0;
            font-family: "Microsoft JhengHei", sans-serif;
            background-color: var(--bg);
        }

        /* ä½ˆå±€è¨­è¨ˆ */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* å´é‚Šæ¬„æ§åˆ¶å€ */
        .sidebar {
            width: 380px;
            background: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            z-index: 1000;
            overflow-y: auto;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        button:hover { background: #2980b9; }

        #ai-output {
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        .itinerary-item {
            border-left: 4px solid var(--accent);
            padding: 10px;
            background: #f1f7ff;
            margin-bottom: 10px;
            border-radius: 0 4px 4px 0;
        }

        /* åœ°åœ–å€ */
        #map {
            flex: 1;
            height: 100%;
        }

        .loading-spinner {
            color: var(--accent);
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>ğŸ‡¹ğŸ‡¼ AI å°ç£æ™ºæ…§æ—…éŠå°è¦½ç³»çµ±</h1>
    </header>

    <div class="main-content">
        <div class="sidebar">
            <div class="input-group">
                <label>ğŸ”‘ OpenAI API Key</label>
                <input type="password" id="api-key" placeholder="sk-...">
            </div>

            <div class="input-group">
                <label>ğŸ“ ç›®çš„åœ°åŸå¸‚</label>
                <select id="city">
                    <option value="å°åŒ—">å°åŒ—</option>
                    <option value="å°ä¸­">å°ä¸­</option>
                    <option value="å—æŠ•æ¸…å¢ƒ">å—æŠ•</option>
                    <option value="å°å—">å°å—</option>
                    <option value="é«˜é›„">é«˜é›„</option>
                    <option value="èŠ±è“®">èŠ±è“®</option>
                </select>
            </div>

            <div class="input-group">
                <label>ğŸ’¬ å‘Šè¨´ AI ä½ çš„éœ€æ±‚æˆ–ä¿®æ”¹å»ºè­°</label>
                <textarea id="preference" rows="4" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³å»æ–‡é’æ™¯é»ï¼Œä¸‹åˆè¦æœ‰ä¸‹åˆèŒ¶ã€‚"></textarea>
            </div>

            <button onclick="generatePlan()">ç”Ÿæˆ / ä¿®æ”¹è¡Œç¨‹</button>
            <button onclick="resetChat()" style="background:#95a5a6;">é‡è¨­å°è©±</button>

            <div id="ai-output">
                <p style="color:#888; text-align:center;">è«‹è¼¸å…¥ API Key ä¸¦æè¿°æ‚¨çš„éœ€æ±‚ä»¥é–‹å§‹è¦åŠƒã€‚</p>
            </div>
        </div>

        <div id="map"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let map;
let markersLayer = L.layerGroup();
let chatHistory = []; // Gemini æ ¼å¼: { role: "user" | "model", parts: [{ text: "" }] }

window.onload = function() {
    map = L.map('map').setView([23.6, 121.0], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    markersLayer.addTo(map);
};

async function generatePlan() {
    const apiKey = document.getElementById('api-key').value.trim();
    const city = document.getElementById('city').value;
    const pref = document.getElementById('preference').value;
    const output = document.getElementById('ai-output');

    if (!apiKey) {
        alert("è«‹è¼¸å…¥ Google AI (Gemini) API Keyï¼");
        return;
    }

    output.innerHTML = `<p class="loading-spinner">Gemini æ­£åœ¨è¦åŠƒ ${city} è¡Œç¨‹... â³</p>`;

    // 1. å»ºç«‹ System Instruction èˆ‡ User Prompt
    const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ç£æ—…éŠå°ˆå®¶ã€‚è«‹ä»¥ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦å§‹çµ‚ä»¥ JSON æ ¼å¼å›å‚³ã€‚æ ¼å¼å¦‚ä¸‹ï¼š{ \"itinerary\": [ { \"time\": \"\", \"spot\": \"\", \"desc\": \"\", \"lat\": ç·¯åº¦æ•¸å­—, \"lng\": ç¶“åº¦æ•¸å­— } ], \"note\": \"\" }";
    
    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡
    if (chatHistory.length === 0) {
        chatHistory.push({ role: "user", parts: [{ text: systemPrompt + "\nç¾åœ¨æˆ‘æƒ³å»" + city + "ï¼Œéœ€æ±‚æ˜¯ï¼š" + pref }] });
    } else {
        chatHistory.push({ role: "user", parts: [{ text: pref }] });
    }

    try {
        // ä½¿ç”¨ Gemini 1.5 Flash æ¨¡å‹ (é€Ÿåº¦å¿«ä¸”å…è²»é¡åº¦é«˜)
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: chatHistory,
                generationConfig: {
                    response_mime_type: "application/json",
                    temperature: 0.7
                }
            })
        });

        const data = await response.json();
        
        if (data.error) throw new Error(data.error.message);

        // è§£æ Gemini çš„å›å‚³è·¯å¾‘
        const aiText = data.candidates[0].content.parts[0].text;
        const aiJson = JSON.parse(aiText);

        // å°‡ AI çš„å›ç­”å­˜å…¥ç´€éŒ„ (æ³¨æ„ Gemini çš„è§’è‰²æ¨™ç±¤æ˜¯ model)
        chatHistory.push({ role: "model", parts: [{ text: aiText }] });

        renderResults(aiJson);
        document.getElementById('preference').value = "";
        document.getElementById('preference').placeholder = "ä¸æ»¿æ„ï¼Ÿç›´æ¥å‘Šè¨´ Gemini å¦‚ä½•ä¿®æ”¹...";

    } catch (error) {
        output.innerHTML = `<p style="color:red">éŒ¯èª¤ï¼š${error.message}<br>è«‹æª¢æŸ¥ API Key æ˜¯å¦æœ‰æ•ˆæˆ–æ˜¯å¦é–‹å•Ÿäº† Gemini API æ¬Šé™ã€‚</p>`;
    }
}

function renderResults(data) {
    const output = document.getElementById('ai-output');
    let html = `<h3>âœ¨ Gemini å»ºè­°è¡Œç¨‹</h3>`;
    const latlngs = [];
    markersLayer.clearLayers();

    data.itinerary.forEach((item, index) => {
        html += `
            <div class="itinerary-item">
                <strong>${index + 1}. ${item.time} - ${item.spot}</strong><br>
                <small>${item.desc}</small>
            </div>`;

        if (item.lat && item.lng) {
            const marker = L.marker([item.lat, item.lng])
                .bindPopup(`<b>${item.spot}</b><br>${item.time}`);
            markersLayer.addLayer(marker);
            latlngs.push([item.lat, item.lng]);
        }
    });

    html += `<p style="font-size:0.85rem; color:#666; border-top:1px solid #ddd; padding-top:10px;">${data.note || ""}</p>`;
    output.innerHTML = html;

    if (latlngs.length > 0) {
        const bounds = L.latLngBounds(latlngs);
        map.fitBounds(bounds, { padding: [50, 50] });
    }
}

function resetChat() {
    chatHistory = [];
    markersLayer.clearLayers();
    document.getElementById('ai-output').innerHTML = "è¡Œç¨‹å·²é‡è¨­ã€‚";
    map.setView([23.6, 121.0], 7);
}

</body>
</html>
