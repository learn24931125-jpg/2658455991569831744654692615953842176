<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
async function startGuide() {
    const apiKey = document.getElementById('api-key').value.trim();
    const dest = document.getElementById('destination').value.trim();
    const aiBox = document.getElementById('ai-box');
    
    if (!apiKey) {
        alert('è«‹å…ˆè¼¸å…¥ Gemini API Key');
        return;
    }
    if (!dest) {
        alert('è«‹è¼¸å…¥æƒ³å»çš„åœ°æ–¹');
        return;
    }

    // 1. é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    aiBox.innerHTML = `<div class="loading">ğŸ¤– AI æ­£åœ¨è¦åŠƒæ‚¨çš„å°ç£ä¹‹æ—…...</div>`;

    // 2. åœ°åœ–å®šä½é‚è¼¯ (ä¿ç•™åŸæœ‰çš„åœ°åœ–ç§»å‹•ä»£ç¢¼)
    handleMapMovement(dest);

    // 3. å‘¼å« Gemini API
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

    const requestBody = {
        contents: [{
            parts: [{
                text: `ä½ æ˜¯ä¸€ä½å°ç£å°ˆæ¥­æ—…éŠå°éŠã€‚è«‹é‡å°ã€Œ${dest}ã€é€™å€‹åœ°é»ï¼Œæä¾›ä»¥ä¸‹è³‡è¨Šï¼š
                1. ç°¡çŸ­çš„åœ°é»æ­·å²èƒŒæ™¯ã€‚
                2. æ¨è–¦ 3 å€‹å¿…å»æ™¯é»ã€‚
                3. ä¸€é …ä¸å®¹éŒ¯éçš„åœ¨åœ°ç¾é£Ÿã€‚
                è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£è¦è¦ªåˆ‡ä¸”å°ˆæ¥­ï¼Œä¸¦é©åº¦ä½¿ç”¨ Emojiã€‚`
            }]
        }]
    };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        const data = await response.json();
        
        if (data.candidates && data.candidates[0].content.parts[0].text) {
            // 4. å°‡ AI å›å‚³çš„ Markdown è½‰æ›ç‚ºç°¡å–® HTML (è™•ç†æ›è¡Œ)
            const aiText = data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
            aiBox.innerHTML = `<div style="animation: fadeIn 0.5s;">${aiText}</div>`;
        } else {
            throw new Error('API å›å‚³æ ¼å¼éŒ¯èª¤');
        }
    } catch (error) {
        console.error('Error:', error);
        aiBox.innerHTML = `<span style="color:red;">âŒ æŠ±æ­‰ï¼ŒAI æš«æ™‚ç„¡æ³•é€£ç·šã€‚è«‹æª¢æŸ¥ API Key æ˜¯å¦æ­£ç¢ºã€‚</span>`;
    }
}

// å°è£åœ°åœ–ç§»å‹•é‚è¼¯
function handleMapMovement(dest) {
    let coords = [23.6, 121.0];
    let found = false;
    for (let key in locationData) {
        if (dest.includes(key)) {
            coords = locationData[key];
            found = true;
            break;
        }
    }
    if (found) {
        markerLayer.clearLayers();
        L.marker(coords).addTo(markerLayer).bindPopup(`<b>${dest}</b>`).openPopup();
        map.flyTo(coords, 14);
    }
}
