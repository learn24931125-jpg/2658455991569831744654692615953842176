<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°ç£æ™ºæ…§æ—…éŠè¦ç•«ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background-color: #f4f7f6; font-family: "Microsoft JhengHei", sans-serif; }
        .header-section { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 2.5rem 0; }
        #map { height: 550px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .config-card { border-top: 5px solid #ffc107; }
        .itinerary-list { height: 400px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        .spot-card { border-left: 4px solid #2a5298; margin-bottom: 10px; padding: 10px; background: #f8f9fa; }
    </style>
</head>
<body>

<header class="header-section text-center mb-4">
    <div class="container">
        <h1>ğŸ‡¹ğŸ‡¼ AI å°ç£æ™ºæ…§æ—…éŠè¦ç•«ç³»çµ±</h1>
        <p>æ•´åˆ Gemini AIï¼šè‡ªå‹•ç”Ÿæˆè¡Œç¨‹ã€ç°¡ä»‹èˆ‡åœ°åœ–æ¨™è¨˜</p>
    </div>
</header>

<div class="container mb-5">
    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-4 shadow-sm config-card">
                <div class="card-body">
                    <h5 class="card-title fw-bold">âš™ï¸ ç¬¬ä¸€æ­¥ï¼šç³»çµ±è¨­å®š</h5>
                    <div class="mb-3">
                        <label class="form-label">Gemini API Key</label>
                        <input type="password" class="form-control" id="apiKey" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API Key">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é¸æ“‡ç›®çš„åœ°åŸå¸‚</label>
                        <select class="form-select" id="city">
                            <option value="å°åŒ—">å°åŒ— Taipei</option>
                            <option value="å°ä¸­">å°ä¸­ Taichung</option>
                            <option value="å°å—">å°å— Tainan</option>
                            <option value="é«˜é›„">é«˜é›„ Kaohsiung</option>
                            <option value="èŠ±è“®">èŠ±è“® Hualien</option>
                            <option value="å®œè˜­">å®œè˜­ Yilan</option>
                        </select>
                    </div>
                    <button class="btn btn-warning w-100 fw-bold" onclick="generateItinerary()">âœ¨ ç”¢ç”Ÿ AI è¡Œç¨‹</button>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title fw-bold">ğŸ“… ç¬¬äºŒæ­¥ï¼šAI å»ºè­°è¡Œç¨‹</h5>
                    <div id="itineraryContent" class="itinerary-list">
                        <p class="text-center text-muted mt-5">è«‹è¼¸å…¥ Key ä¸¦é»æ“Šç”¢ç”Ÿè¡Œç¨‹</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-body p-2">
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    // 1. åˆå§‹åŒ–åœ°åœ–
const map = L.map('map').setView([23.6, 121.0], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
}).addTo(map);

let markersLayer = L.layerGroup().addTo(map);

async function generateItinerary() {
    const apiKey = document.getElementById('apiKey').value;
    const city = document.getElementById('city').value;
    const contentDiv = document.getElementById('itineraryContent');

    if (!apiKey) {
        alert("è«‹è¼¸å…¥ API Keyï¼");
        return;
    }

    contentDiv.innerHTML = `<div class="text-center mt-5"><div class="spinner-border text-primary"></div><p>AI æ­£åœ¨è¦åŠƒä¸­...</p></div>`;
    markersLayer.clearLayers();

    const prompt = `ä½ æ˜¯ä¸€ä½å°ç£æ—…éŠå°ˆå®¶ã€‚è«‹è¦åŠƒ ${city} çš„ä¸€æ—¥éŠè¡Œç¨‹ã€‚
    è«‹å…ˆçµ¦å‡ºè©³ç´°è¡Œç¨‹èªªæ˜ï¼Œä¸¦åœ¨æœ€å¾Œä¸€è¡ŒåŠ ä¸Šåº§æ¨™è³‡æ–™ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    COORDS: [{"name":"æ™¯é»å", "lat": 25.0, "lng": 121.5}]`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
            })
        });

        const data = await response.json();

        // --- éŒ¯èª¤æª¢æŸ¥æ©Ÿåˆ¶ ---
        if (data.error) {
            throw new Error(`API éŒ¯èª¤: ${data.error.message}`);
        }
        if (!data.candidates || data.candidates.length === 0) {
            throw new Error("AI æœªèƒ½ç”¢ç”Ÿå…§å®¹ï¼Œè«‹æª¢æŸ¥ API Key æˆ–å®‰å…¨è¨­å®šã€‚");
        }
        // ------------------

        const aiResponse = data.candidates[0].content.parts[0].text;

        // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼å°‹æ‰¾ JSON éƒ¨åˆ†
        const coordMatch = aiResponse.match(/COORDS:\s*(\[.*\])/s);
        let textContent = aiResponse;
        let jsonData = [];

        if (coordMatch) {
            textContent = aiResponse.split("COORDS:")[0];
            try {
                jsonData = JSON.parse(coordMatch[1]);
            } catch (e) {
                console.error("JSON è§£æå¤±æ•—", e);
            }
        }

        contentDiv.innerHTML = `<div style="white-space: pre-line;">${textContent}</div>`;

        if (jsonData.length > 0) {
            renderMarkers(jsonData);
        }

    } catch (error) {
        contentDiv.innerHTML = `<div class="alert alert-danger">âŒ ${error.message}</div>`;
        console.error(error);
    }
}

function renderMarkers(locations) {
    const bounds = [];
    locations.forEach(loc => {
        if (loc.lat && loc.lng) {
            const marker = L.marker([loc.lat, loc.lng]).addTo(markersLayer);
            marker.bindPopup(`<b>${loc.name}</b>`);
            bounds.push([loc.lat, loc.lng]);
        }
    });
    
    if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [50, 50] });
    }
}

    // 3. åœ°åœ–æ¨™é»å‡½å¼
    function renderMarkers(locations) {
        const bounds = [];
        locations.forEach(loc => {
            const marker = L.marker([loc.lat, loc.lng]).addTo(markersLayer);
            marker.bindPopup(`<b>${loc.name}</b>`).openPopup();
            bounds.push([loc.lat, loc.lng]);
        });
        
        // è‡ªå‹•ç¸®æ”¾åœ°åœ–ä»¥åŒ…å«æ‰€æœ‰é»
        if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
