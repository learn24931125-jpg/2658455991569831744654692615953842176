<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°ç£æ—…éŠè¦ç•«ç³»çµ±</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --error: #e74c3c; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f4f4f9; }
        header { background: var(--primary); color: white; padding: 1rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 350px; background: white; padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .section-title { font-weight: bold; border-left: 4px solid var(--accent); padding-left: 10px; margin: 10px 0; }
        input, select, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
        button { background: var(--accent); color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #219150; }
        #map { flex: 1; position: relative; }
        .status-bar { position: absolute; bottom: 20px; left: 20px; z-index: 1000; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 12px; }
        .day-card { background: #f1f8f4; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid var(--accent); }
    </style>
</head>
<body>

<header><h1>ğŸŒ AI å°ç£æ™ºæ…§æ—…éŠè¡Œç¨‹è¦ç•«</h1></header>

<div class="main-container">
    <aside class="sidebar">
        <div class="section-title">API é‡‘é‘°è¨­å®š</div>
        <input type="password" id="api-key" placeholder="è²¼ä¸Š Gemini API Key">
        <button style="background: #34495e;" onclick="listModels()">æª¢æŸ¥å¯ç”¨æ¨¡å‹æ¸…å–®</button>

        <div class="section-title">è¡Œç¨‹åå¥½</div>
        <label>ç›®çš„åœ°</label>
        <select id="destination">
            <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
            <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
            <option value="å°å—å¸‚">å°å—å¸‚</option>
            <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
            <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
        </select>
        
        <label>æ—…éŠå¤©æ•¸ (1-5)</label>
        <input type="number" id="days" value="2" min="1" max="5">

        <label>æ—…éŠé¢¨æ ¼</label>
        <select id="style">
            <option value="åœ¨åœ°ç¾é£Ÿèˆ‡å¤œå¸‚">ç¾é£Ÿåƒè²¨</option>
            <option value="æˆ¶å¤–è‡ªç„¶èˆ‡ç¾æ™¯">è‡ªç„¶å±±æµ·</option>
            <option value="æ­·å²æ–‡åŒ–èˆ‡å¤è¹Ÿ">æ–‡é’å¤è¹Ÿ</option>
        </select>

        <button onclick="planTrip()">ç”Ÿæˆ AI æ™ºæ…§è·¯ç·š</button>

        <div id="itinerary-list"></div>
    </aside>

    <main id="map">
        <div class="status-bar" id="status">æº–å‚™å°±ç·’</div>
    </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. åˆå§‹åŒ–åœ°åœ– (é è¨­å°åŒ—)
    const map = L.map('map').setView([25.033, 121.565], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    const layerGroup = L.featureGroup().addTo(map);

    // 2. è¨ºæ–·åŠŸèƒ½ï¼šåˆ—å‡ºæ¨¡å‹ (è§£æ±ºä½ é‡åˆ°çš„ 404 å•é¡Œ)
    async function listModels() {
        const key = document.getElementById('api-key').value.trim();
        if (!key) return alert("è«‹å…ˆè¼¸å…¥ Key");
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            const data = await res.json();
            console.log("æ‚¨çš„å¯ç”¨æ¨¡å‹æ¸…å–®:", data);
            alert("å·²åœ¨ç€è¦½å™¨æ§åˆ¶å° (F12) åˆ—å‡ºæ‰€æœ‰æ¨¡å‹ï¼Œè«‹æŸ¥çœ‹ name æ¬„ä½ã€‚");
        } catch (e) {
            alert("ç„¡æ³•ç²å–æ¸…å–®: " + e.message);
        }
    }

    // 3. æ ¸å¿ƒåŠŸèƒ½ï¼šè¡Œç¨‹è¦ç•«
    async function planTrip() {
        const key = document.getElementById('api-key').value.trim();
        const status = document.getElementById('status');
        const listDiv = document.getElementById('itinerary-list');

        if (!key) return alert("è«‹è¼¸å…¥ API Key");

        status.innerText = "ğŸš€ AI æ€è€ƒä¸­...";
        listDiv.innerHTML = "";

        const dest = document.getElementById('destination').value;
        const days = document.getElementById('days').value;
        const style = document.getElementById('style').value;

        // æç¤ºè©å„ªåŒ–ï¼šå¼·åˆ¶è¦æ±‚æ¨™æº– JSON
        const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­å°éŠã€‚è«‹è¦åŠƒ${dest}çš„${days}å¤©${style}æ—…éŠè¡Œç¨‹ã€‚
        å›å‚³æ ¼å¼å¿…é ˆæ˜¯åš´æ ¼çš„ JSON é™£åˆ—ï¼Œä¸åŒ…å« Markdown æ¨™ç±¤ã€‚ç¯„ä¾‹ï¼š
        [{"day": 1, "order": 1, "name": "æ™¯é»å", "lat": 25.0, "lng": 121.0, "desc": "æè¿°"}]`;

        // æ³¨æ„ï¼šé€™è£¡å˜—è©¦ä½¿ç”¨ gemini-1.5-flash-latestï¼Œå¦‚æœå¤±æ•—è«‹æª¢æŸ¥ listModels
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error.message);

            let text = data.candidates[0].content.parts[0].text;
            // éæ¿¾å¯èƒ½çš„ Markdown èªæ³•
            const jsonStr = text.replace(/```json|```/g, "").trim();
            const spots = JSON.parse(jsonStr);

            renderOnMap(spots);
            status.innerText = "âœ… è¡Œç¨‹ç”ŸæˆæˆåŠŸï¼";
        } catch (error) {
            status.innerText = "âŒ éŒ¯èª¤: " + error.message;
            console.error(error);
        }
    }

    // 4. ç¹ªè£½æ¨™è¨˜èˆ‡è·¯å¾‘
    function renderOnMap(spots) {
        layerGroup.clearLayers();
        const listDiv = document.getElementById('itinerary-list');
        const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6'];
        const dayMap = {};

        spots.forEach(s => {
            if (!dayMap[s.day]) dayMap[s.day] = [];
            dayMap[s.day].push(s);
        });

        Object.keys(dayMap).forEach((day, i) => {
            const currentSpots = dayMap[day].sort((a, b) => a.order - b.order);
            const color = colors[i % colors.length];
            const coords = [];

            const dayCard = document.createElement('div');
            dayCard.className = 'day-card';
            dayCard.innerHTML = `<strong>ç¬¬ ${day} å¤© (${document.getElementById('style').value})</strong><br>`;

            currentSpots.forEach(spot => {
                coords.push([spot.lat, spot.lng]);
                L.marker([spot.lat, spot.lng])
                    .bindPopup(`<b>${spot.name}</b><br>${spot.desc}`)
                    .addTo(layerGroup);
                dayCard.innerHTML += `${spot.order}. ${spot.name}<br>`;
            });

            L.polyline(coords, { color: color, weight: 5, opacity: 0.7, dashArray: '10, 10' }).addTo(layerGroup);
            listDiv.appendChild(dayCard);
        });

        map.fitBounds(layerGroup.getBounds().pad(0.1));
    }
</script>

</body>
</html>        
