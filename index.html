<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºæ…§æ—…éŠå°è¦½ç³»çµ± - å°ç£ (Neumorphism)</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* ========================================= */
        /* CSS æ¨£å¼ (å„ªåŒ–ç‰ˆ Neumorphism) */
        /* ========================================= */
        :root {
            /* ä¸»é¡Œè‰²è®Šæ•¸ */
            --main-color: #e0e5ec; 
            --light-color: #ffffff;
            --dark-color: #a3b1c6; 
            --primary-color: #4CAF50; /* ç¶ è‰² */
            --accent-color: #007bff; /* è—è‰² */
            --error-color: #dc3545; /* ç´…è‰² */
            --border-radius: 12px;

            /* Neumorphism é™°å½±åƒæ•¸ */
            --shadow-out: 7px 7px 15px var(--dark-color), -7px -7px 15px var(--light-color);
            --shadow-in: inset 5px 5px 10px var(--dark-color), inset -5px -5px 10px var(--light-color);
            --shadow-pressed: inset 3px 3px 7px var(--dark-color), inset -3px -3px 7px var(--light-color);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Segoe UI', Tahoma, sans-serif;
        }

        body {
            background-color: var(--main-color);
            padding: 20px;
        }

        .container {
            display: grid;
            grid-template-columns: 280px 1fr; 
            grid-template-rows: auto 1fr; 
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* --- Neumorphism åŸºç¤æ¨£å¼ --- */

        .neumorphism-panel, .neumorphism-card {
            background: var(--main-color);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-out); 
            transition: all 0.3s ease;
        }

        .header-panel {
            grid-column: 1 / -1; 
            text-align: center;
            padding: 30px 20px;
        }

        .sidebar {
            grid-row: 2 / 3;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* è¼¸å…¥æ¡†å’Œé¸æ“‡æ¡† */
        .neumorphism-input, .neumorphism-select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: none;
            background: var(--main-color);
            border-radius: 8px;
            box-shadow: var(--shadow-in); 
            color: #333;
        }

        .neumorphism-input:focus, .neumorphism-select:focus {
            outline: none;
            box-shadow: inset 2px 2px 5px var(--dark-color); 
        }

        /* é¸å–®é …ç›® */
        .menu-list { list-style: none; padding: 0; }
        .neumorphism-item {
            display: block;
            text-decoration: none;
            color: #333;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: var(--shadow-out); 
        }

        .neumorphism-item:hover:not(.active):not(.disabled) {
            box-shadow: var(--shadow-pressed); 
            color: var(--accent-color);
        }

        .neumorphism-item.active {
            box-shadow: var(--shadow-in); 
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .neumorphism-item.disabled {
            color: #999;
            cursor: default;
            box-shadow: none;
            background: #f0f4f8;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .neumorphism-button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: var(--shadow-out); 
            transition: all 0.2s ease-in-out;
            margin-top: 10px;
        }

        .neumorphism-button:active {
            box-shadow: var(--shadow-in); 
        }

        .primary-button { color: white; background-color: var(--primary-color); }
        .accent-button { color: white; background-color: var(--accent-color); }
        .small-button { padding: 8px 12px; font-size: 0.9em; margin-right: 5px; }

        /* --- ä¸»è¦å…§å®¹å€ --- */

        .main-content {
            grid-column: 2 / 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .attraction-card {
            width: calc(50% - 10px); 
            display: flex;
            overflow: hidden;
            display: none; /* åˆå§‹ç‹€æ…‹ï¼Œç”± JS æ§åˆ¶é¡¯ç¤º */
            cursor: pointer;
        }
        
        .card-image-placeholder {
            width: 40%;
            min-height: 180px;
            background-color: #d8dee8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-style: italic;
            color: #666;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            text-align: center;
            overflow: hidden;
        }

        .card-image-placeholder img { width: 100%; height: 100%; object-fit: cover; }
        .card-content { width: 60%; padding: 15px; }
        .description { margin: 10px 0 15px; color: #555; font-size: 0.9em; }

        /* åœ°åœ–å±•ç¤ºå€ */
        .map-placeholder {
            width: 100%;
            min-height: 400px;
            background-color: #d8dee8;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #444;
            box-shadow: var(--shadow-in); 
            text-align: center;
            padding: 20px;
        }

        .route-planning label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: 500; }
        .route-planning button { width: 100%; }
        pre { white-space: pre-wrap; font-family: monospace; line-height: 1.5; text-align: left; }
        .route-message {
            margin-top: 15px;
            padding: 10px;
            font-size: 0.9em;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="neumorphism-panel header-panel">
            <h1>ğŸ‡¹ğŸ‡¼ AIæ™ºæ…§æ—…éŠå°è¦½ç³»çµ±</h1>
            <p>é€é Gemini AI è¦åŠƒæ‚¨çš„å°ç£ä¹‹æ—…ï¼Œæ¢ç´¢ç²¾å½©æ™¯é»ã€‚</p>
        </header>

        <section class="api-settings neumorphism-panel">
            <h2>âš™ï¸ API è¨­å®šå€</h2>
            <div class="input-group">
                <label for="gemini-key">Gemini API Key:</label>
                <input type="password" id="gemini-key" placeholder="è¼¸å…¥æ‚¨çš„API Key" class="neumorphism-input">
                <p id="api-status" style="font-size: 0.9em; margin-top: 5px;"></p>
            </div>
            <button id="verify-api-btn" class="neumorphism-button primary-button">é©—è­‰ä¸¦ä¿å­˜è¨­å®š</button>
        </section>

        <nav class="sidebar neumorphism-panel">
            <h2>ğŸ—ºï¸ è·¯ç·šè¦åŠƒèˆ‡æ™¯é»</h2>
            
            <ul class="menu-list" id="category-menu">
                <li><a href="#" class="neumorphism-item active" data-action="filter-all">ğŸ‡¹ğŸ‡¼ æ‰€æœ‰æ™¯é»</a></li>
                <li><a href="#" class="neumorphism-item" data-action="filter-nature">ğŸï¸ è‡ªç„¶é¢¨å…‰</a></li>
                <li><a href="#" class="neumorphism-item" data-action="filter-history">ğŸ›ï¸ æ­·å²æ–‡åŒ–</a></li>
            </ul>

            <hr style="border-top: 1px solid #c0c0c0; margin: 15px 0;">

            <div class="route-overview">
                <h3>ğŸ“… AI è¡Œç¨‹æ¦‚è¦½</h3>
                <ul id="itinerary-days-menu" class="menu-list">
                    <li><a href="#" class="neumorphism-item disabled">é»æ“Šã€Œç”Ÿæˆå„ªåŒ–è·¯ç·šã€</a></li>
                </ul>
            </div>

            <div class="route-planning">
                <h3>AI è·¯ç·šç”Ÿæˆ</h3>
                
                <label for="start-location">èµ·å§‹åœ°ï¼š</label>
                <input type="text" id="start-location" placeholder="e.g., å°åŒ—è»Šç«™" class="neumorphism-input">

                <label for="interest-tags">æ—…éŠåå¥½ (Tag)ï¼š</label>
                <input type="text" id="interest-tags" placeholder="e.g., è‡ªç„¶,ç¾é£Ÿ" class="neumorphism-input">

                <label for="duration-days">å¤©æ•¸ï¼š</label>
                <select id="duration-days" class="neumorphism-select">
                    <option value="1">1å¤©</option>
                    <option value="2">2å¤©</option>
                    <option value="3" selected>3å¤©</option>
                    <option value="5">5å¤©</option>
                </select>
                
                <label for="must-visit">å¿…è¨ªæ™¯é» (Ctrl/Cmd+Clickå¡ç‰‡)</label>
                <input type="text" id="must-visit" placeholder="e.g., 101,æ—¥æœˆæ½­" class="neumorphism-input">

                <button id="generate-route-btn" class="neumorphism-button accent-button">ğŸ”¥ ç”Ÿæˆå„ªåŒ–è·¯ç·š</button>
                
                <div id="route-result" class="route-message" style="display:none;">
                    </div>
            </div>
        </nav>

        <main class="main-content">
            <section class="attraction-cards">
                <h2>ğŸŒŸ ç²¾é¸æ™¯é»å¡ç‰‡</h2>
                <p style="font-size: 0.9em; color: #555; margin-bottom: 20px;">
                    ğŸ’¡ **æç¤º:** æŒ‰ä½ **Ctrl** (æˆ– **Cmd**) éµé»æ“Šå¡ç‰‡ï¼Œå¯å°‡å…¶è¨­ç‚ºå¿…è¨ªç›®çš„åœ°ã€‚
                </p>
                <div id="cards-container" class="cards-container">
                    </div>
            </section>

            <section id="map-display" class="map-display neumorphism-panel">
                <h2>ğŸ“ åœ°åœ–å±•ç¤ºå€</h2>
                <div id="map-placeholder" class="map-placeholder">
                    [åœ°åœ–æ¨¡æ“¬ç•«é¢ï¼šé¡¯ç¤ºè·¯ç·šå’Œæ™¯é»æ¨™è¨˜]
                </div>
            </section>
        </main>
    </div>

    <script>
        /* ========================================= */
        /* JavaScript äº’å‹•é‚è¼¯ (å„ªåŒ–èˆ‡æ•´åˆ) */
        /* ========================================= */

        // --- æ¨¡æ“¬è³‡æ–™èˆ‡å…¨åŸŸè®Šæ•¸ ---
        const taiwanAttractions = [
            { id: 'sunmoon', name: 'æ—¥æœˆæ½­', description: 'è‡ºç£æœ€å¤§çš„å¤©ç„¶æ¹–æ³Šï¼Œæ¹–å…‰å±±è‰²ï¼Œé¢¨æ™¯ç§€éº—ã€‚', coordinates: 'N 23.8966, E 120.9167', coord_val: { x: 10, y: 15 }, score: 95, tags: ['è‡ªç„¶', 'æ¹–æ™¯', 'ä¼‘é–’'], image: 'images/sunmoon_default.jpg' },
            { id: 'taipei101', name: 'å°åŒ—101', description: 'æ›¾ç‚ºä¸–ç•Œç¬¬ä¸€é«˜æ¨“ï¼Œæ˜¯å°åŒ—å¸‚é‡è¦çš„åœ°æ¨™ã€‚', coordinates: 'N 25.0330, E 121.5654', coord_val: { x: 5, y: 5 }, score: 98, tags: ['åŸå¸‚', 'åœ°æ¨™', 'è³¼ç‰©'], image: 'images/taipei101_default.jpg' },
            { id: 'taroko', name: 'å¤ªé­¯é–£åœ‹å®¶å…¬åœ’', description: 'ä»¥é›„å‰å£¯éº—çš„å³½è°·æ™¯è§€èåã€‚', coordinates: 'N 24.1667, E 121.5000', coord_val: { x: 30, y: 25 }, score: 92, tags: ['è‡ªç„¶', 'å³½è°·', 'å¥è¡Œ'], image: 'images/taroko_default.jpg' },
            { id: 'ali', name: 'é˜¿é‡Œå±±', description: 'äº”å¥‡ï¼ˆæ—¥å‡ºã€é›²æµ·ã€æ™šéœã€æ£®æ—ã€éµé“ï¼‰èåä¸­å¤–ã€‚', coordinates: 'N 23.5152, E 120.8123', coord_val: { x: 15, y: 35 }, score: 90, tags: ['è‡ªç„¶', 'æ—¥å‡º', 'æ£®æ—'], image: 'images/ali_default.jpg' },
            { id: 'tainan_old', name: 'å®‰å¹³å¤å ¡', description: 'è‡ºç£æœ€å¤è€çš„åŸå ¡ä¹‹ä¸€ï¼Œè¦‹è­‰äº†è‡ºç£æ­·å²çš„è®Šé·ã€‚', coordinates: 'N 23.0016, E 120.1656', coord_val: { x: 25, y: 10 }, score: 88, tags: ['æ­·å²', 'æ–‡åŒ–', 'å¤è¹Ÿ'], image: 'images/tainan_default.jpg' },
            { id: 'kaohsiung_harbor', name: 'é«˜é›„æ¸¯', description: 'è‡ºç£æœ€å¤§çš„æµ·æ¸¯ï¼Œå¤œæ™šçš„ç‡ˆå…‰æ™¯è‰²éå¸¸è¿·äººã€‚', coordinates: 'N 22.6167, E 120.2833', coord_val: { x: 20, y: 40 }, score: 85, tags: ['åŸå¸‚', 'æµ·æ¸¯', 'å¤œæ™¯'], image: 'images/kaohsiung_default.jpg' }
        ];
        let currentOptimizedRoute = null; 

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ ---

        function getDistance(p1, p2) {
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        function createAttractionCard(attraction) {
            const imgSrc = attraction.image.includes('default') 
                ? `[AI ç”Ÿæˆåœ–ç‰‡é è¦½å€]` 
                : `<img src="${attraction.image}" alt="${attraction.name}">`;
            
            return `
                <div class="attraction-card neumorphism-card" data-id="${attraction.id}">
                    <div class="card-image-placeholder" id="img-placeholder-${attraction.id}">${imgSrc}</div>
                    <div class="card-content">
                        <h3 class="card-title">${attraction.name}</h3>
                        <p class="description card-description-${attraction.id}">${attraction.description.substring(0, 20)}...</p>
                        <div class="card-details card-details-${attraction.id}" style="display:none; margin-bottom: 10px;">
                            <p><strong>åº§æ¨™:</strong> <span class="card-coord">${attraction.coordinates}</span></p>
                        </div>
                        <button class="neumorphism-button small-button toggle-details-btn" data-action="toggle-details" data-id="${attraction.id}">
                            æŸ¥çœ‹è©³æƒ…
                        </button>
                        <button class="neumorphism-button small-button generate-image-btn" data-action="generate-image" data-name="${attraction.name}">
                            æ¨¡æ“¬ AI ç”Ÿæˆæ–°åœ–
                        </button>
                    </div>
                </div>
            `;
        }
        
        function loadAttractionCards() {
            document.getElementById('cards-container').innerHTML = taiwanAttractions.map(createAttractionCard).join('');
            filterCardsByDay(0); // é è¨­é¡¯ç¤ºæ‰€æœ‰å¡ç‰‡
        }

        function handleApiVerification() {
            const key = document.getElementById('gemini-key').value.trim();
            const statusText = document.getElementById('api-status');

            if (key.length > 10 && key.startsWith('AIZA')) {
                statusText.innerHTML = 'âœ… API Key é©—è­‰æˆåŠŸï¼';
                statusText.style.color = 'var(--primary-color)';
                localStorage.setItem('geminiApiKey', key);
            } else {
                statusText.innerHTML = 'âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ Gemini API Keyã€‚ (æ¨¡æ“¬æ ¼å¼: AIZA...)';
                statusText.style.color = 'var(--error-color)';
                localStorage.removeItem('geminiApiKey');
            }
        }

        function toggleDetails(cardId) {
            const card = taiwanAttractions.find(a => a.id === cardId);
            const detailsDiv = document.querySelector(`.card-details-${cardId}`);
            const descriptionP = document.querySelector(`.card-description-${cardId}`);
            const toggleBtn = document.querySelector(`.toggle-details-btn[data-id="${cardId}"]`);

            const isExpanded = detailsDiv.style.display === 'block';

            if (!isExpanded) {
                detailsDiv.style.display = 'block';
                descriptionP.innerHTML = card.description;
                toggleBtn.textContent = 'éš±è—è©³æƒ…';
                updateMapDisplaySingle(card);
            } else {
                detailsDiv.style.display = 'none';
                descriptionP.innerHTML = card.description.substring(0, 20) + '...';
                toggleBtn.textContent = 'æŸ¥çœ‹è©³æƒ…';
                // å˜—è©¦æ¢å¾©å¤šæ™¯é»æˆ–æ¸…ç©ºåœ°åœ–
                const activeDayBtn = document.querySelector('#itinerary-days-menu .active');
                if (activeDayBtn) {
                     filterCardsByDay(activeDayBtn.getAttribute('data-day'));
                } else {
                     updateMapDisplayMultiple([]);
                }
            }
        }

        function simulateAIGeneration(attractionName, cardId) {
            if (!localStorage.getItem('geminiApiKey')) {
                alert('è«‹å…ˆåœ¨ã€ŒAPI è¨­å®šå€ã€è¼¸å…¥ä¸¦é©—è­‰ Gemini API Keyï¼');
                return;
            }
            
            const imgPlaceholder = document.getElementById(`img-placeholder-${cardId}`);
            imgPlaceholder.innerHTML = 'ğŸ–¼ï¸ AI æ­£åœ¨ç”Ÿæˆåœ–ç‰‡ä¸­...';
            imgPlaceholder.style.backgroundColor = '#e0f7fa';

            setTimeout(() => {
                const newImageUrl = `https://picsum.photos/seed/${Math.random()}/300/200`;
                imgPlaceholder.innerHTML = `<img src="${newImageUrl}" alt="AI ç”Ÿæˆçš„ ${attractionName} åœ–ç‰‡">`;
                imgPlaceholder.style.backgroundColor = '#d8dee8';
                
                const card = taiwanAttractions.find(a => a.name === attractionName);
                if (card) card.image = newImageUrl;
            }, 2000);
        }
        
        function generateOptimizedRoute(startLocation, interestTags, durationDays, mustVisitNames) {
            const totalDays = parseInt(durationDays, 10);
            const requiredTags = interestTags.split(',').map(tag => tag.trim().toLowerCase()).filter(t => t);
            const mustVisit = mustVisitNames.split(',').map(name => name.trim()).filter(n => n);
            
            let filteredAttractions = taiwanAttractions.filter(attraction => {
                const tagMatch = requiredTags.length === 0 || attraction.tags.some(tag => requiredTags.includes(tag.toLowerCase()));
                return tagMatch;
            });

            // è·¯ç”±é‚è¼¯ (æ¨¡æ“¬ TSP/è²ªå©ªæ³•)
            let selectedRoute = taiwanAttractions.filter(a => mustVisit.includes(a.name));
            let pool = filteredAttractions.filter(a => !mustVisit.includes(a.name));
            
            const maxAttractions = totalDays * 3;
            pool.sort((a, b) => b.score - a.score);
            for (let i = 0; selectedRoute.length < maxAttractions && i < pool.length; i++) {
                selectedRoute.push(pool[i]);
            }

            if (selectedRoute.length === 0) return "æ‰¾ä¸åˆ°ç¬¦åˆæ‚¨æ¢ä»¶çš„æ™¯é»ã€‚";

            let optimizedOrder = [];
            let currentPoint = { name: startLocation, coord_val: { x: 20, y: 10 } }; 
            let remaining = [...selectedRoute];

            while (remaining.length > 0) {
                let nearestIndex = -1, minDistance = Infinity;
                for (let i = 0; i < remaining.length; i++) {
                    const dist = getDistance(currentPoint.coord_val, remaining[i].coord_val);
                    if (dist < minDistance) {
                        minDistance = dist;
                        nearestIndex = i;
                    }
                }
                const nextAttraction = remaining.splice(nearestIndex, 1)[0];
                optimizedOrder.push(nextAttraction);
                currentPoint = nextAttraction;
            }

            // åˆ†æ—¥è¦åŠƒèˆ‡æ–‡æœ¬ç”Ÿæˆ
            const attractionsPerDay = Math.ceil(optimizedOrder.length / totalDays);
            let itinerary = [];
            let dailyStops = [];
            let totalDistance = 0;

            for (let day = 0; day < totalDays; day++) {
                const startIndex = day * attractionsPerDay;
                const stops = optimizedOrder.slice(startIndex, startIndex + attractionsPerDay);
                
                if (stops.length > 0) {
                    dailyStops.push(stops);
                    let dailyRoute = [`å¾ ${day === 0 ? startLocation : 'å‰ä¸€å¤©ä½å®¿åœ°é»'} å‡ºç™¼`];
                    let lastCoord = day === 0 ? { x: 20, y: 10 } : stops[0].coord_val;
                    
                    stops.forEach((stop) => {
                        const travelDist = getDistance(lastCoord, stop.coord_val);
                        totalDistance += travelDist;
                        dailyRoute.push(`â¡ï¸ è¨ªå• ${stop.name} (åœç•™ç´„ 3å°æ™‚ï¼Œè·é›¢æ¨¡æ“¬: ${travelDist.toFixed(1)} km)`);
                        lastCoord = stop.coord_val;
                    });

                    dailyRoute.push(`ğŸ›Œ æ™šä¸Šåœ¨ ${stops[stops.length - 1].name} é™„è¿‘ä½å®¿ã€‚`);
                    itinerary.push(`**ç¬¬ ${day + 1} å¤©:**\n* ` + dailyRoute.join('\n* '));
                }
            }

            return { itinerary: itinerary.join('\n\n'), totalDistance: totalDistance.toFixed(1), dailyStops: dailyStops };
        }

        // --- ä»‹é¢æ›´æ–°å‡½æ•¸ ---

        function updateSidebarOverview(dailyStops) {
            const menu = document.getElementById('itinerary-days-menu');
            menu.innerHTML = '';
            
            if (!dailyStops || dailyStops.length === 0) {
                menu.innerHTML = '<li><a href="#" class="neumorphism-item disabled">é»æ“Šã€Œç”Ÿæˆå„ªåŒ–è·¯ç·šã€</a></li>';
                filterCardsByDay(0); 
                return;
            }

            menu.innerHTML += `
                <li>
                    <a href="#" class="neumorphism-item route-day-btn" data-action="filter-day" data-day="all">
                        ğŸ‘ï¸ é¡¯ç¤ºæ‰€æœ‰è¡Œç¨‹æ™¯é»
                    </a>
                </li>
            `;

            dailyStops.forEach((dayStops, index) => {
                const day = index + 1;
                menu.innerHTML += `
                    <li>
                        <a href="#" class="neumorphism-item route-day-btn" data-action="filter-day" data-day="${day}">
                            ğŸ—“ï¸ ç¬¬ ${day} å¤© (${dayStops.length} ç«™)
                        </a>
                    </li>
                `;
            });
            
            // é è¨­é¸ä¸­ç¬¬ä¸€å¤©
            const firstDayBtn = document.querySelector('.route-day-btn[data-day="1"]') || document.querySelector('.route-day-btn[data-day="all"]');
            if (firstDayBtn) {
                 firstDayBtn.classList.add('active');
                 filterCardsByDay(firstDayBtn.getAttribute('data-day'));
            }
        }
        
        function filterCardsByDay(day) {
            const allCards = document.querySelectorAll('.attraction-card');
            let visibleIds = [], attractionsToShow = [];

            if (day === 0 || day === 'all-category') { 
                allCards.forEach(card => card.style.display = 'flex');
                updateMapDisplayMultiple([]);
                return;
            } else if (day === 'all' && currentOptimizedRoute) { 
                attractionsToShow = currentOptimizedRoute.flat();
            } else if (currentOptimizedRoute && day > 0) { 
                const dayIndex = day - 1;
                if (currentOptimizedRoute[dayIndex]) attractionsToShow = currentOptimizedRoute[dayIndex];
            }
            
            visibleIds = attractionsToShow.map(a => a.id);
            allCards.forEach(card => card.style.display = visibleIds.includes(card.getAttribute('data-id')) ? 'flex' : 'none');
            updateMapDisplayMultiple(attractionsToShow);
        }

        function updateMapDisplaySingle(attraction) {
            const mapPlaceholder = document.getElementById('map-placeholder');
            mapPlaceholder.innerHTML = `
                <h3>ğŸ“Œ ${attraction.name} (åº§æ¨™: ${attraction.coordinates})</h3>
                <p>åœ°åœ–æ¨¡æ“¬ï¼šé¡¯ç¤ºä»¥ ${attraction.name} ç‚ºä¸­å¿ƒçš„åœ–è³‡å’Œå–®ä¸€æ¨™è¨˜ã€‚</p>
                <p style="color:#007bff; font-weight:normal;">(å¯¦éš›æ‡‰ç”¨ä¸­æ­¤è™•æœƒåµŒå…¥äº’å‹•å¼åœ°åœ–)</p>
            `;
            mapPlaceholder.style.backgroundColor = '#f0f4f8';
        }

        function updateMapDisplayMultiple(attractions) {
            const mapPlaceholder = document.getElementById('map-placeholder');
            const color = attractions.length > 0 ? '#f0f4f8' : '#d8dee8';
            
            if (attractions && attractions.length > 0) {
                const attractionNames = attractions.map(a => a.name).join(' â†’ ');
                mapPlaceholder.innerHTML = `
                    <h3>ğŸ—ºï¸ ç•¶å‰è¡Œç¨‹åœ°åœ–è¦–åœ–</h3>
                    <p>åœ°åœ–æ¨¡æ“¬ï¼šé¡¯ç¤º ${attractions.length} å€‹æ™¯é»ä¸¦æ¨™è¨˜è·¯ç·š:</p>
                    <p style="font-weight:normal;">${attractionNames}</p>
                    <p style="color:#007bff; font-weight:normal;">(å¯¦éš›æ‡‰ç”¨ä¸­æ­¤è™•æœƒé¡¯ç¤ºè¡Œç¨‹é€£ç·šåœ–)</p>
                `;
            } else {
                mapPlaceholder.innerHTML = '[åœ°åœ–æ¨¡æ“¬ç•«é¢ï¼šé¡¯ç¤ºè·¯ç·šå’Œæ™¯é»æ¨™è¨˜]';
            }
            mapPlaceholder.style.backgroundColor = color;
        }

        // --- äº‹ä»¶è™•ç†å™¨ (çµ±ä¸€å§”æ´¾) ---
        
        function handleGlobalClick(event) {
            const target = event.target;
            const action = target.getAttribute('data-action');
            
            if (action) {
                event.preventDefault();

                if (action === 'toggle-details') {
                    toggleDetails(target.getAttribute('data-id'));
                } else if (action === 'generate-image') {
                    simulateAIGeneration(target.getAttribute('data-name'), target.closest('.attraction-card').getAttribute('data-id'));
                } else if (action.startsWith('filter-')) {
                    // è™•ç†å´é‚Šæ¬„çš„ç¯©é¸å’Œå¤©æ•¸åˆ‡æ›
                    document.querySelectorAll('.neumorphism-item.active').forEach(btn => btn.classList.remove('active'));
                    target.classList.add('active');
                    
                    const day = target.getAttribute('data-day');
                    if (day) {
                        filterCardsByDay(day === 'all' ? 'all' : parseInt(day, 10));
                    } else {
                        // åŸå§‹åˆ†é¡é»æ“Šï¼Œé‡ç½®ç‚ºé¡¯ç¤ºæ‰€æœ‰
                        filterCardsByDay('all-category');
                    }
                }
            }
        }
        
        function handleCardClickForMustVisit(event) {
            const targetCard = event.target.closest('.attraction-card');
            
            if (targetCard && (event.ctrlKey || event.metaKey)) {
                event.preventDefault();
                
                const cardId = targetCard.getAttribute('data-id');
                const attraction = taiwanAttractions.find(a => a.id === cardId);
                
                if (attraction) {
                    const mustVisitInput = document.getElementById('must-visit');
                    const currentMustVisit = mustVisitInput.value.split(',').map(n => n.trim()).filter(n => n);
                    const attractionName = attraction.name;

                    if (!currentMustVisit.includes(attractionName)) {
                        mustVisitInput.value = currentMustVisit.join(', ') + (currentMustVisit.length > 0 ? ', ' : '') + attractionName;
                        
                        alert(`å·²å°‡ã€Œ${attractionName}ã€åŠ å…¥å¿…è¨ªæ™¯é»æ¸…å–®ã€‚`);
                        
                        // è¦–è¦ºå›é¥‹
                        targetCard.style.boxShadow = 'var(--shadow-out), 0 0 10px var(--accent-color)';
                        setTimeout(() => targetCard.style.boxShadow = 'var(--shadow-out)', 500);
                    } else {
                        alert(`ã€Œ${attractionName}ã€å·²åœ¨å¿…è¨ªæ¸…å–®ä¸­ã€‚`);
                    }
                }
            }
        }

        function handleRouteGeneration() {
            const resultDiv = document.getElementById('route-result');
            const start = document.getElementById('start-location').value || 'å°ç£ä»»ä¸€åœ°é»';
            const tags = document.getElementById('interest-tags').value;
            const days = document.getElementById('duration-days').value;
            const must = document.getElementById('must-visit').value;
            
            if (!localStorage.getItem('geminiApiKey')) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<p style="color:var(--error-color);">è«‹å…ˆé©—è­‰æ‚¨çš„ API Key æ‰èƒ½ä½¿ç”¨ AI è¦åŠƒåŠŸèƒ½ï¼</p>';
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>ğŸš€ AI æ­£åœ¨è™•ç†è¤‡é›œçš„æ—…è¡Œæ¨éŠ·å“¡å•é¡Œ (TSP)...</p>';
            resultDiv.style.backgroundColor = 'var(--main-color)';
            
            setTimeout(() => {
                const routeData = generateOptimizedRoute(start, tags, days, must);

                if (typeof routeData === 'string') {
                    resultDiv.innerHTML = `<p style="color:var(--error-color);">${routeData}</p>`;
                    currentOptimizedRoute = null;
                    updateSidebarOverview(null);
                } else {
                    resultDiv.innerHTML = `
                        <h4>âœ… æœ€ä½³åŒ–è¡Œç¨‹ (å…± ${routeData.totalDistance} km æ¨¡æ“¬è·é›¢)</h4>
                        <pre style="white-space: pre-wrap; background: #e0e5ec; padding: 10px; border-radius: 8px;">${routeData.itinerary}</pre>
                        <p><em>æ­¤è·¯ç·šå·²æ ¹æ“šæ‚¨çš„åå¥½å’Œåœ°ç†ä½ç½®æ¡ç”¨è²ªå©ªæ³•é€²è¡Œå„ªåŒ–ã€‚</em></p>
                    `;
                    
                    currentOptimizedRoute = routeData.dailyStops;
                    updateSidebarOverview(routeData.dailyStops);
                }
            }, 1500);
        }


        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAttractionCards();
            
            // ç¶å®š API é©—è­‰æŒ‰éˆ•
            document.getElementById('verify-api-btn').addEventListener('click', handleApiVerification);
            
            // ç¶å®šè·¯ç·šç”ŸæˆæŒ‰éˆ•
            document.getElementById('generate-route-btn').addEventListener('click', handleRouteGeneration);

            // å…¨åŸŸé»æ“Šäº‹ä»¶å§”æ´¾ (è™•ç† sidebar å’Œå¡ç‰‡æŒ‰éˆ•)
            document.addEventListener('click', handleGlobalClick);

            // æ™¯é»å¡ç‰‡é»æ“Šè¨­å®šç›®çš„åœ°åŠŸèƒ½ (Ctrl/Cmd + Click)
            document.getElementById('cards-container').addEventListener('click', handleCardClickForMustVisit);
        });
    </script>
</body>
</html>
