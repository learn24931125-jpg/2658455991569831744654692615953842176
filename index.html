<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°ç£æ™ºæ…§æ—…éŠè¦ç•«ç³»çµ±</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    
    <style>
        :root { --primary-color: #0d6efd; --sidebar-bg: #ffffff; }
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; }
        .hero-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 2rem 0; shadow: 0 2px 10px rgba(0,0,0,0.2); }
        #map { height: 500px; width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1; }
        .config-card { border: none; border-radius: 15px; transition: 0.3s; }
        .poi-item { border-left: 4px solid var(--primary-color); margin-bottom: 10px; transition: 0.2s; }
        .poi-item:hover { background-color: #f8f9fa; transform: translateX(5px); }
        /* éš±è— Routing Machine é è¨­çš„æ–‡å­—é¢æ¿ï¼Œè®“ç•«é¢æ›´ä¹¾æ·¨ */
        .leaflet-routing-container { display: none; }
    </style>
</head>
<body>

<header class="hero-header text-center mb-4">
    <div class="container">
        <h1 class="display-5 fw-bold">ğŸ‡¹ğŸ‡¼ AI å°ç£æ™ºæ…§æ—…éŠè¦ç•«</h1>
        <p class="lead">æ•´åˆ Gemini AI èˆ‡ Leaflet å¯¦æ™‚è·¯ç·šå°èˆª</p>
    </div>
</header>

<div class="container pb-5">
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card config-card p-4 shadow-sm mb-4">
                <h5 class="fw-bold mb-3">ğŸ”‘ API è¨­å®š</h5>
                <div class="input-group mb-2">
                    <input type="password" id="apiKey" class="form-control" placeholder="è¼¸å…¥ Gemini API Key">
                    <button class="btn btn-primary" onclick="verifyApiKey()" id="btnVerify">é©—è­‰</button>
                </div>
                <div id="verifyStatus" class="small"></div>
            </div>

            <div class="card config-card p-4 shadow-sm">
                <h5 class="fw-bold mb-3">ğŸ—ºï¸ è¡Œç¨‹åå¥½</h5>
                <div class="mb-3">
                    <label class="form-label">é¸æ“‡åŸå¸‚</label>
                    <select class="form-select" id="citySelect">
                        <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
                        <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
                        <option value="å°å—å¸‚">å°å—å¸‚</option>
                        <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
                        <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">æ—…éŠä¸»é¡Œ</label>
                    <input type="text" id="themeInput" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ–‡é’å’–å•¡åº—ã€è¦ªå­è‡ªç„¶">
                </div>
                <button class="btn btn-success w-100 fw-bold py-2" id="btnGenerate" onclick="generateAiTrip()" disabled>
                    âœ¨ ç”Ÿæˆ AI æ™ºæ…§è¡Œç¨‹
                </button>
            </div>

            <div class="mt-4">
                <h5 class="fw-bold">ğŸ“ æ™¯é»æ¸…å–®</h5>
                <div id="poiList" class="list-group">
                    </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div id="map"></div>
            <div class="card config-card p-4 mt-4 shadow-sm">
                <h5 class="fw-bold text-primary">ğŸ“ è¡Œç¨‹èªªæ˜</h5>
                <div id="tripDescription" class="text-muted">
                    è«‹å…ˆé©—è­‰ API Key ä¸¦é»æ“Šç”ŸæˆæŒ‰éˆ•...
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
    let map, routingControl, isApiValid = false;
    let markersLayer = L.layerGroup();

    // 1. åˆå§‹åŒ–åœ°åœ–
    function initMap() {
        map = L.map('map').setView([23.6, 121.0], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);
        markersLayer.addTo(map);
    }
    initMap();

    // 2. é©—è­‰ API Key
    async function verifyApiKey() {
        const key = document.getElementById('apiKey').value;
        const status = document.getElementById('verifyStatus');
        const btn = document.getElementById('btnVerify');

        status.innerHTML = "â³ é©—è­‰ä¸­...";
        try {
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: "hi" }] }] })
            });
            if (resp.ok) {
                status.innerHTML = "âœ… é©—è­‰æˆåŠŸï¼å¯ä»¥é–‹å§‹ç”Ÿæˆè¡Œç¨‹ã€‚";
                status.className = "text-success small";
                isApiValid = true;
                document.getElementById('btnGenerate').disabled = false;
            } else {
                throw new Error();
            }
        } catch (e) {
            status.innerHTML = "âŒ Key ç„¡æ•ˆï¼Œè«‹é‡æ–°æª¢æŸ¥ã€‚";
            status.className = "text-danger small";
        }
    }

    // 3. å‘¼å« AI ä¸¦ç”Ÿæˆè¡Œç¨‹
    async function generateAiTrip() {
        const key = document.getElementById('apiKey').value;
        const city = document.getElementById('citySelect').value;
        const theme = document.getElementById('themeInput').value || "ç†±é–€æ™¯é»";
        const descEl = document.getElementById('tripDescription');
        
        descEl.innerHTML = "ğŸŒ€ AI æ­£åœ¨è¦ç•«æœ€ä½³è·¯ç·šèˆ‡åˆ†ææ™¯é»...";
        
        const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ç£æ—…éŠå°ˆå®¶ã€‚è«‹æ ¹æ“šåŸå¸‚èˆ‡ä¸»é¡Œè¦ç•«3-4å€‹æ™¯é»ã€‚
        å¿…é ˆåƒ…å›å‚³ JSON æ ¼å¼é™£åˆ—ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
        [{"name":"æ™¯é»å","lat":25.0,"lng":121.5,"desc":"ç°¡ä»‹"}]
        è«‹ç¢ºä¿æ™¯é»é–“çš„äº¤é€šé †åºåˆç†ã€‚`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `${systemPrompt}\n\néœ€æ±‚ï¼š${city}çš„${theme}ä¸€æ—¥éŠ` }] }],
                    generationConfig: { responseMimeType: "application/json" }
                })
            });

            const data = await response.json();
            const locations = JSON.parse(data.candidates[0].content.parts[0].text);
            
            drawRoute(locations);
            updateUI(locations);
            descEl.innerHTML = `æˆåŠŸç‚ºæ‚¨è¦ç•«äº† ${locations.length} å€‹ä½æ–¼ ${city} çš„è¡Œç¨‹ï¼`;

        } catch (e) {
            descEl.innerHTML = "âŒ ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            console.error(e);
        }
    }

    // 4. ç¹ªè£½è·¯ç·š
    function drawRoute(locations) {
        if (routingControl) map.removeControl(routingControl);
        markersLayer.clearLayers();

        const waypoints = locations.map(loc => L.latLng(loc.lat, loc.lng));

        routingControl = L.Routing.control({
            waypoints: waypoints,
            routeWhileDragging: false,
            addWaypoints: false,
            createMarker: (i, wp) => {
                return L.marker(wp.latLng).bindPopup(`<b>${locations[i].name}</b><br>${locations[i].desc}`);
            },
            lineOptions: { styles: [{ color: '#0d6efd', weight: 5 }] }
        }).addTo(map);

        const bounds = L.latLngBounds(waypoints);
        map.fitBounds(bounds.pad(0.3));
    }

    // 5. æ›´æ–° UI æ¸…å–®
    function updateUI(locations) {
        const list = document.getElementById('poiList');
        list.innerHTML = locations.map((loc, i) => `
            <div class="list-group-item poi-item shadow-sm p-3">
                <div class="fw-bold text-primary">ç¬¬ ${i+1} ç«™: ${loc.name}</div>
                <div class="small text-muted">${loc.desc}</div>
            </div>
        `).join('');
    }
</script>

</body>
</html>
