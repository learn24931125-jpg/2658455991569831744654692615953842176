<H1>智慧旅遊導覽</H1>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>台灣 AI 旅遊規畫系統 - 最終修復版</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        #map { height: 500px; width: 100%; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .marker-index { background: #2563eb; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 2px solid white; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-6xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">台灣 AI 智慧旅遊規畫</h1>
            <p class="text-blue-600">API 狀態：連線正常 ✅</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-4">
                <div class="bg-white p-5 rounded-xl shadow">
                    <label class="block text-sm font-bold text-gray-700 mb-2">1. API Key (已儲存)</label>
                    <input type="password" id="apiKey" value="AIzaSyD1wo67sEiVujXhIRtGTJ3l2WyipxTImwk" class="w-full border p-2 rounded bg-gray-50 text-gray-500" readonly>
                    
                    <label class="block text-sm font-bold text-gray-700 mt-4 mb-2">2. 輸入旅程需求</label>
                    <input type="text" id="destination" placeholder="例如：花蓮太魯閣一日遊" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    
                    <button onclick="generateTrip()" id="btn" class="w-full mt-4 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg">
                        開始生成 AI 行程
                    </button>
                </div>

                <div id="itinerary" class="bg-white p-5 rounded-xl shadow hidden h-96 overflow-y-auto">
                    <h2 class="font-bold border-b pb-2 mb-3">建議行程路線</h2>
                    <div id="route-list" class="space-y-3"></div>
                </div>
            </div>

            <div class="lg:col-span-8 bg-white p-2 rounded-xl shadow">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
        // 初始化地圖
        const map = L.map('map').setView([23.9739, 120.9796], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let markers = L.layerGroup().addTo(map);
        let polyline = null;

      async function generateTrip() {
    const key = document.getElementById('apiKey').value;
    const dest = document.getElementById('destination').value;
    const btn = document.getElementById('btn');
    
    if (!dest) return alert("請輸入目的地！");

    btn.disabled = true;
    btn.innerText = "AI 正在計算路線...";

    // 定義可能的模型名稱順序，解決 404 問題
    const modelOptions = [
        "gemini-1.5-flash",
        "gemini-1.5-flash-latest",
        "gemini-pro"
    ];

    let success = false;
    let errorMessage = "";

    for (let modelName of modelOptions) {
        if (success) break;
        
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`;
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: `你是一位專業導遊。請以 JSON 格式規劃台灣「${dest}」。格式：[{"name":"名稱","lat":25.0,"lng":121.5,"desc":"簡介"}]` }] }] })
            });

            const data = await response.json();
            
            if (response.ok && data.candidates) {
                let rawText = data.candidates[0].content.parts[0].text;
                const cleanJson = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                const locations = JSON.parse(cleanJson);
                renderMapAndList(locations);
                success = true;
                console.log(`使用模型成功: ${modelName}`);
            } else {
                errorMessage = data.error?.message || "未知錯誤";
                console.warn(`模型 ${modelName} 嘗試失敗: ${errorMessage}`);
            }
        } catch (error) {
            errorMessage = error.message;
        }
    }

    if (!success) {
        alert("所有模型皆無法調用，請確認您在 Google AI Studio 介面左側是否有看到 gemini-1.5-flash 模型可選。錯誤訊息：" + errorMessage);
    }

    btn.disabled = false;
    btn.innerText = "開始生成 AI 行程";
}

            // 使用經測試正確的 API 端點
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;

            const prompt = `你是一位專業導遊。請規劃「${dest}」。
            要求：
            1. 僅回傳 JSON 陣列格式。
            2. 格式範例：[{"name":"景點A","lat":25.0,"lng":121.5,"desc":"簡介"}]
            3. 地點須在台灣境內。`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error?.message || "API 調用失敗");

                let rawText = data.candidates[0].content.parts[0].text;
                // 強制清理 Markdown 語法 (常見的 AI 錯誤回傳格式)
                const cleanJson = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                const locations = JSON.parse(cleanJson);

                renderMapAndList(locations);
            } catch (error) {
                console.error(error);
                alert("生成失敗：" + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "開始生成 AI 行程";
            }
        }

        function renderMapAndList(locations) {
            markers.clearLayers();
            if (polyline) map.removeLayer(polyline);
            const listEl = document.getElementById('route-list');
            document.getElementById('itinerary').classList.remove('hidden');
            listEl.innerHTML = "";

            const points = [];
            const bounds = L.latLngBounds();

            locations.forEach((loc, i) => {
                const pos = [loc.lat, loc.lng];
                points.push(pos);
                bounds.extend(pos);

                // 添加地圖標記
                const marker = L.marker(pos, {
                    icon: L.divIcon({ className: '', html: `<div class="marker-index">${i+1}</div>`, iconSize: [24, 24] })
                }).bindPopup(`<b>${loc.name}</b><br>${loc.desc}`).addTo(markers);

                // 添加左側列表項目
                const item = document.createElement('div');
                item.className = "p-3 border rounded-lg hover:bg-blue-50 cursor-pointer transition";
                item.innerHTML = `<h3 class="font-bold text-sm text-blue-800">${i+1}. ${loc.name}</h3><p class="text-xs text-gray-500">${loc.desc}</p>`;
                item.onclick = () => { map.flyTo(pos, 15); marker.openPopup(); };
                listEl.appendChild(item);
            });

            // 畫出導航連線
            polyline = L.polyline(points, { color: '#2563eb', weight: 3, dashArray: '5, 8', opacity: 0.7 }).addTo(map);
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    </script>
</body>
</html>
