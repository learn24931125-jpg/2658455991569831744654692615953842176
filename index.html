<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºæ…§å°ç£å°è¦½ç³»çµ±</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --bg: #f8f9fa;
        }

        body { font-family: 'Microsoft JhengHei', sans-serif; margin: 0; background: var(--bg); }
        
        header { 
            background: var(--primary); color: white; padding: 1.5rem; text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container { display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; max-width: 1400px; margin: auto; }

        /* å·¦å´æ§åˆ¶æ¬„ */
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        h3 { margin-top: 0; color: var(--primary); font-size: 1.1rem; border-left: 4px solid var(--accent); padding-left: 10px; }

        input[type="text"] {
            width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;
        }

        button {
            width: 100%; background: var(--accent); color: white; border: none; padding: 12px;
            border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s;
        }

        button:hover { background: #219150; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* æ™¯é»å¡ç‰‡ */
        #attractions { display: flex; flex-direction: column; gap: 15px; margin-top: 10px; }
        .card { 
            background: #fff; border: 1px solid #eee; border-radius: 8px; overflow: hidden;
            transition: 0.3s; cursor: pointer;
        }
        .card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .card img { width: 100%; height: 120px; object-fit: cover; }
        .card-body { padding: 10px; }
        .card-body h4 { margin: 0 0 5px 0; font-size: 1rem; }
        .card-body p { margin: 0; font-size: 0.85rem; color: #666; line-height: 1.4; }

        /* å³å´åœ°åœ– */
        #map { height: calc(100vh - 120px); border-radius: 12px; position: sticky; top: 20px; z-index: 1; }

        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
            #map { height: 400px; position: relative; top: 0; }
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸ‡¹ğŸ‡¼ AI æ™ºæ…§å°ç£æ—…éŠå°è¦½</h1>
</header>

<div class="container">
    <div class="sidebar">
        <div class="panel">
            <h3>ğŸ”‘ ç³»çµ±è¨­å®š</h3>
            <input type="text" id="apiKey" placeholder="è¼¸å…¥ Gemini API Key">
            <button onclick="saveConfig()">å„²å­˜é‡‘é‘°</button>
        </div>

        <div class="panel">
            <h3>ğŸ’¬ è¦åŠƒè¡Œç¨‹</h3>
            <p style="font-size: 0.8rem; color: #888;">è¼¸å…¥éœ€æ±‚ï¼ŒAI ç‚ºæ‚¨æ¨è–¦æ™¯é»ï¼š</p>
            <input type="text" id="userQuery" placeholder="ä¾‹å¦‚ï¼šæ¨è–¦å°å—ç¾é£Ÿèˆ‡å¤è¹Ÿ">
            <button onclick="askAI()" id="sendBtn">é–‹å§‹è¦åŠƒ / ä¿®æ”¹</button>
            
            <div id="attractions">
                </div>
        </div>
    </div>

    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let GEMINI_API_KEY = "";
    let map, markers = [], currentAttractions = [], chatHistory = [];

    // åˆå§‹åŒ–åœ°åœ–
    function initMap() {
        map = L.map('map').setView([23.6, 121.0], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);
    }
    initMap();

    function saveConfig() {
        const key = document.getElementById('apiKey').value;
        if (key) {
            GEMINI_API_KEY = key;
            alert("é‡‘é‘°å·²å„²å­˜ï¼");
        }
    }

    async function askAI() {
        const input = document.getElementById('userQuery');
        const btn = document.getElementById('sendBtn');
        const query = input.value.trim();

        if (!GEMINI_API_KEY) return alert("è«‹å…ˆè¼¸å…¥ API Key");
        if (!query) return alert("è«‹è¼¸å…¥éœ€æ±‚");

        btn.disabled = true;
        btn.innerText = "AI æ­£åœ¨è¦åŠƒä¸­...";

        // æ§‹å»º Prompt
        const prompt = `
            ä½ æ˜¯ä¸€ä½å°ˆæ¥­å°ç£å°éŠã€‚
            ç•¶å‰è¡Œç¨‹ç‹€æ…‹ï¼š${JSON.stringify(currentAttractions)}
            ä½¿ç”¨è€…æ–°éœ€æ±‚ï¼š'${query}'
            è«‹æ ¹æ“šéœ€æ±‚æä¾› 3 å€‹ç›¸é—œæ™¯é»ã€‚å‹™å¿…åªå›å‚³ç´” JSON é™£åˆ—ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
            [{"name":"æ™¯é»å","desc":"ç°¡ä»‹","lat":ç·¯åº¦æ•¸å­—,"lng":ç¶“åº¦æ•¸å­—,"img":"è‹±æ–‡é—œéµå­—"}]
        `;

        chatHistory.push({ role: "user", parts: [{ text: prompt }] });

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: chatHistory })
            });

            const data = await response.json();
            const resText = data.candidates[0].content.parts[0].text;
            const cleanJson = resText.replace(/```json|```/g, "").trim();
            
            currentAttractions = JSON.parse(cleanJson);
            chatHistory.push({ role: "model", parts: [{ text: resText }] });

            renderUI();
            input.value = "";
        } catch (e) {
            console.error(e);
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯ç‹€æ³ã€‚");
        } finally {
            btn.disabled = false;
            btn.innerText = "é–‹å§‹è¦åŠƒ / ä¿®æ”¹";
        }
    }

    function renderUI() {
        const container = document.getElementById('attractions');
        container.innerHTML = "";
        
        // æ¸…é™¤èˆŠåœ°åœ–æ¨™è¨˜
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        const bounds = [];

        currentAttractions.forEach(loc => {
            // 1. ç”Ÿæˆå¡ç‰‡
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => {
                map.setView([loc.lat, loc.lng], 15);
                markers.find(m => m.getLatLng().lat === loc.lat).openPopup();
            };
            card.innerHTML = `
                <img src="https://source.unsplash.com/featured/400x200?${loc.img},taiwan">
                <div class="card-body">
                    <h4>${loc.name}</h4>
                    <p>${loc.desc}</p>
                </div>
            `;
            container.appendChild(card);

            // 2. ç”Ÿæˆåœ°åœ–æ¨™è¨˜
            const m = L.marker([loc.lat, loc.lng]).addTo(map).bindPopup(`<b>${loc.name}</b>`);
            markers.push(m);
            bounds.push([loc.lat, loc.lng]);
        });

        if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
    }
</script>

</body>
</html>
