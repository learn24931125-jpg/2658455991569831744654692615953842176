<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>AI æ™ºæ…§å°èˆª - Gemini 2.0 Flash ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        :root { --primary: #1a1a1a; --accent: #00d2ff; --rain: #607d8b; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; }
        header { background: var(--primary); color: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 380px; padding: 20px; background: white; box-shadow: 2px 0 15px rgba(0,0,0,0.1); overflow-y: auto; z-index: 10; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #444; }
        input, button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; transition: transform 0.2s; }
        button:active { transform: scale(0.98); }
        #status { margin: 10px 0; font-size: 0.85rem; padding: 10px; border-radius: 5px; background: #eef2f7; min-height: 40px; }
        .trip-card { border-left: 5px solid var(--accent); background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .rain-mode { border-left-color: #546e7a; background: #eceff1; }
        .weather-info { display: flex; align-items: center; gap: 8px; margin-top: 8px; font-weight: bold; color: #555; font-size: 0.9rem; }
        #map { flex: 1; }
    </style>
</head>
<body>

<header>ğŸš€ AI æ—…éŠåŠ©ç† (Gemini 2.0 Flash å¼•æ“)</header>

<div class="main-container">
    <aside id="sidebar">
        <div class="input-group">
            <label>Gemini API Key</label>
            <input type="password" id="api-key" placeholder="è²¼ä¸Š API Key">
        </div>
        <div class="input-group">
            <label>ç›®çš„åœ°èˆ‡æ™‚é–“</label>
            <input type="text" id="user-prompt" placeholder="ä¾‹å¦‚ï¼šé€™é€±æœ«å»å°ä¸­çœ‹å±•è¦½" value="é€™é€±æœ«å»å°å—ç©">
        </div>
        <button onclick="startAiTrip()">ğŸŒ å•Ÿå‹• 2.0 Flash è¦åŠƒ</button>
        <div id="status">æº–å‚™å°±ç·’</div>
        <div id="itinerary-list"></div>
    </aside>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    const map = L.map('map').setView([23.6, 121.0], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let routingControl = null;

    const getWeatherLabel = (code) => {
        const codes = { 0: "â˜€ï¸ æ™´æœ—", 1: "ğŸŒ¤ï¸ å¤šé›²æ™‚æ™´", 2: "â›… å¤šé›²", 3: "â˜ï¸ é™°å¤©", 45: "ğŸŒ«ï¸ æœ‰éœ§", 61: "ğŸŒ§ï¸ å°é›¨", 95: "â›ˆï¸ é›·é™£é›¨" };
        return codes[code] || "â›… å¤šé›²";
    };

    async function startAiTrip() {
        const key = document.getElementById('api-key').value.trim();
        const prompt = document.getElementById('user-prompt').value.trim();
        const status = document.getElementById('status');
        const list = document.getElementById('itinerary-list');

        if (!key) return alert("è«‹è¼¸å…¥ API Key");
        
        status.innerHTML = "â³ æ­£åœ¨å®šä½ç›®çš„åœ°ä¸¦ç²å– Open-Meteo å¤©æ°£...";
        list.innerHTML = "";

        try {
            // 1. åœ°ç†ç·¨ç¢¼å®šä½
            const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(prompt)}&format=json&limit=1`);
            const geoData = await geoRes.json();
            if (!geoData[0]) throw new Error("æ‰¾ä¸åˆ°è©²åœ°é»ï¼Œè«‹è¼¸å…¥æ›´å…·é«”çš„åå­—");
            const { lat, lon: lng } = geoData[0];

            // 2. ç²å–å¤©æ°£é å ±
            const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max&timezone=auto`);
            const weatherData = await weatherRes.json();
            const rainCode = weatherData.daily.weathercode[0]; 
            const isRainy = [51, 61, 80, 95].includes(rainCode);
            const localWeather = getWeatherLabel(rainCode);

            status.innerHTML = `ğŸ§¬ Gemini 2.0 é‹ç®—ä¸­... (é å ±ï¼š${localWeather})`;

            // 3. å‘¼å« Gemini 2.0 Flash
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;
            const sysPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­å°éŠã€‚è«‹è¦åŠƒ3å€‹æ™¯é»ã€‚
            ç•¶å‰å¤©æ°£é å ±ï¼š${localWeather}ã€‚
            ${isRainy ? 'ç”±æ–¼é æ¸¬ä¸‹é›¨ï¼Œè«‹å„ªå…ˆæ¨è–¦å®¤å…§æ™¯é»ï¼ˆå¦‚åšç‰©é¤¨ã€å•†å ´ã€å·¥å» ï¼‰ã€‚' : 'å¤©æ°£è‰¯å¥½ï¼Œè«‹æ¨è–¦æˆ¶å¤–æ´»å‹•æˆ–è‡ªç„¶æ™¯è§€ã€‚'}
            åš´æ ¼å›å‚³ JSON é™£åˆ—ï¼š[{"name":"åç¨±","type":"indoor|outdoor","lat":25.0,"lng":121.0,"desc":"ä»‹ç´¹"}]`;

            const aiRes = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: `${sysPrompt}\néœ€æ±‚ï¼š${prompt}` }] }] })
            });

            const aiData = await aiRes.json();
            if (!aiRes.ok) throw new Error(aiData.error.message);

            const locations = JSON.parse(aiData.candidates[0].content.parts[0].text.match(/\[[\s\S]*\]/)[0]);

            // 4. æ¸²æŸ“ UI
            locations.forEach(loc => {
                const card = document.createElement('div');
                card.className = `trip-card ${isRainy && loc.type === 'indoor' ? 'rain-mode' : ''}`;
                card.innerHTML = `
                    <strong>${loc.name}</strong> <span style="font-size:0.7rem; color:#888;">${loc.type === 'indoor' ? 'ğŸ  å®¤å…§' : 'ğŸŒ³ æˆ¶å¤–'}</span><br>
                    <small style="color:#555;">${loc.desc}</small>
                    <div class="weather-info">é å ±: ${localWeather} | ${weatherData.daily.temperature_2m_max[0]}Â°C</div>
                `;
                list.appendChild(card);
            });

            drawMapRoute(locations);
            status.innerHTML = `âœ… è¦åŠƒå®Œæˆï¼(æ¨¡å‹ï¼šGemini 2.0 Flash)`;

        } catch (e) {
            status.innerHTML = `âŒ éŒ¯èª¤ï¼š${e.message}`;
            console.error(e);
        }
    }

    function drawMapRoute(locations) {
        if (routingControl) map.removeControl(routingControl);
        const wps = locations.map(l => L.latLng(l.lat, l.lng));
        routingControl = L.Routing.control({
            waypoints: wps,
            routeWhileDragging: false,
            createMarker: (i, wp) => L.marker(wp.latLng).bindPopup(`<b>${locations[i].name}</b>`)
        }).addTo(map);
        map.fitBounds(L.latLngBounds(wps), { padding: [50, 50] });
    }
</script>
</body>
</html>
