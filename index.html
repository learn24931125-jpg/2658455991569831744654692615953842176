<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºæ…§æ—…éŠå°è¦½ç³»çµ±</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            margin: 0; background: #f0f2f5; display: flex; flex-direction: column; min-height: 100vh;
        }

        /* ç»ç’ƒæ“¬æ…‹ UI */
        header {
            background: var(--primary-gradient); color: white; padding: 2rem; text-align: center;
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; position: relative;
        }

        #api-section {
            background: var(--glass-bg); margin: 10px 20px; padding: 15px; border-radius: 15px;
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; backdrop-filter: blur(10px);
        }

        .container { display: grid; grid-template-columns: 1fr 400px; gap: 20px; padding: 20px; flex-grow: 1; }

        /* åœ°åœ–èˆ‡èŠå¤©å®¤ */
        #map-area { height: 600px; border-radius: 20px; box-shadow: var(--shadow); z-index: 1; }
        
        #chat-widget {
            background: var(--glass-bg); border-radius: 20px; display: flex; flex-direction: column;
            height: 600px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);
            box-shadow: var(--shadow); overflow: hidden;
        }

        #chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .message { padding: 12px 16px; border-radius: 15px; max-width: 85%; line-height: 1.6; font-size: 14px; }
        .user-message { align-self: flex-end; background: #3b82f6; color: white; }
        .ai-message { align-self: flex-start; background: white; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* ç…§ç‰‡èˆ‡æŒ‰éˆ• */
        .attraction-photo { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin: 10px 0; }
        .btn-nav { 
            display: inline-block; padding: 6px 12px; background: var(--primary-gradient); 
            color: white; text-decoration: none; border-radius: 8px; font-size: 12px;
        }

        input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        button { cursor: pointer; border: none; padding: 8px 16px; border-radius: 20px; transition: 0.3s; }
        
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <div style="position: absolute; top: 10px; right: 20px;">
        <button onclick="switchLang('zh')">ç¹ä¸­</button>
        <button onclick="switchLang('en')">EN</button>
        <button onclick="switchLang('ja')">æ—¥æœ¬èª</button>
    </div>
    <h1 id="txt-title">ğŸŒ AI æ™ºæ…§æ—…éŠå°è¦½ç³»çµ±</h1>
    <p id="txt-subtitle">æ¢ç´¢å°ç£ä¹‹ç¾ï¼Œè®“ AI ç‚ºæ‚¨è¦åŠƒå°ˆå±¬è¡Œç¨‹</p>
</header>

<section id="api-section">
    <input type="password" id="apiKey" placeholder="Gemini API Key">
    <input type="password" id="weatherKey" placeholder="OpenWeather Key">
    <button onclick="alert('Keys Saved Locally!')" style="background:#10b981; color:white;">å„²å­˜è¨­å®š</button>
</section>

<div class="container">
    <main id="map-area"></main>

    <aside id="chat-widget">
        <div style="background:rgba(0,0,0,0.05); padding:10px; display:flex; justify-content:space-between;">
            <span style="font-weight:bold;">âœ¨ AI Assistant</span>
            <button onclick="downloadItinerary()" style="font-size:12px; background:#059669; color:white;">PDF</button>
        </div>
        <div id="chat-messages">
            <div class="message ai-message">æ‚¨å¥½ï¼æƒ³å»å“ªè£¡ç©ï¼Ÿæˆ‘å¯ä»¥æ ¹æ“šå¤©æ°£ç‚ºæ‚¨è¦åŠƒè¡Œç¨‹ã€‚</div>
        </div>
        <div style="padding:15px; display:flex; gap:10px; background:white;">
            <input type="text" id="userInput" style="flex-grow:1;" placeholder="è¼¸å…¥éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šå°å—å…©å¤©ä¸€å¤œ">
            <button onclick="sendMessage()" style="background:#3b82f6; color:white;">ç™¼é€</button>
        </div>
    </aside>
</div>

<script>
    // --- 1. åˆå§‹åŒ–åœ°åœ– ---
    let map = L.map('map-area').setView([23.6, 121.0], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let markers = [];
    let currentLang = 'zh';

    // --- 2. èªè¨€èˆ‡ç¿»è­¯ ---
    const i18n = {
        'zh': { title: "ğŸŒ AI æ™ºæ…§æ—…éŠå°è¦½ç³»çµ±", prompt: "ä½ æ˜¯ä¸€ä½å°ç£å°éŠï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚" },
        'en': { title: "ğŸŒ AI Travel Guide", prompt: "You are a Taiwan guide, please respond in English." },
        'ja': { title: "ğŸŒ AI å°æ¹¾ã‚¬ã‚¤ãƒ‰", prompt: "ã‚ãªãŸã¯å°æ¹¾ã®ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚æ—¥æœ¬èªã§ç­”ãˆã¦ãã ã•ã„ã€‚" }
    };

    function switchLang(lang) {
        currentLang = lang;
        document.getElementById('txt-title').innerText = i18n[lang].title;
    }

    // --- 3. å¤©æ°£ API ---
    async function getCityWeather(city) {
        const key = document.getElementById('weatherKey').value;
        if(!key) return null;
        try {
            const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&lang=${currentLang}&appid=${key}`);
            return await r.json();
        } catch(e) { return null; }
    }

    // --- 4. æ ¸å¿ƒç™¼é€é‚è¼¯ ---
    async function sendMessage() {
        const apiKey = document.getElementById('apiKey').value;
        const userInput = document.getElementById('userInput').value;
        if(!userInput || !apiKey) return alert("è«‹è¼¸å…¥éœ€æ±‚ä¸¦ç¢ºä¿ API Key å·²å¡«å¯«");

        appendMessage('user', userInput);
        document.getElementById('userInput').value = '';

        // æ¨¡æ“¬åŸå¸‚åµæ¸¬ (ç°¡å–®é‚è¼¯)
        const cityMatch = userInput.match(/å°åŒ—|å°ä¸­|å°å—|é«˜é›„|èŠ±è“®/) || ["å°åŒ—"];
        const weatherData = await getCityWeather(cityMatch[0]);
        
        const weatherContext = weatherData ? `ç›®å‰${cityMatch[0]}å¤©æ°£ï¼š${weatherData.weather[0].description}, ${weatherData.main.temp}Â°Cã€‚` : "";

        // å‘¼å« Gemini
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `${i18n[currentLang].prompt}\n${weatherContext}\néœ€æ±‚ï¼š${userInput}\nè«‹è¦åŠƒè¡Œç¨‹ä¸¦åœ¨æœ€å¾ŒåŠ ä¸Šï¼š[MAP_DATA] [{"name":"åç¨±","lat":0,"lng":0,"img_key":"è‹±æ–‡é—œéµå­—"}] [/MAP_DATA]` }]}]
                })
            });
            const data = await response.json();
            const fullText = data.candidates[0].content.parts[0].text;

            // è§£æåœ°åœ–æ•¸æ“š
            const mapMatch = fullText.match(/\[MAP_DATA\](.*?)\[\/MAP_DATA\]/s);
            const cleanText = fullText.replace(/\[MAP_DATA\].*?\[\/MAP_DATA\]/s, '');
            
            appendMessage('ai', cleanText);

            if(mapMatch) {
                const locations = JSON.parse(mapMatch[1]);
                updateMap(locations);
            }
        } catch(e) { appendMessage('ai', "ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯ã€‚"); }
    }

    function appendMessage(sender, text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}-message`;
        msgDiv.innerText = text;
        document.getElementById('chat-messages').appendChild(msgDiv);
        document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    }

    // --- 5. æ›´æ–°åœ°åœ–èˆ‡ç…§ç‰‡ ---
    function updateMap(locations) {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        const bounds = [];

        locations.forEach(loc => {
            const imgUrl = `https://source.unsplash.com/400x200/?${loc.img_key || loc.name}`;
            const marker = L.marker([loc.lat, loc.lng]).addTo(map)
                .bindPopup(`<b>${loc.name}</b><br><img src="${imgUrl}" style="width:100px;border-radius:5px;"><br><a href="https://www.google.com/maps?q=${loc.lat},${loc.lng}" target="_blank">å°èˆª</a>`);
            markers.push(marker);
            bounds.push([loc.lat, loc.lng]);
        });
        if(bounds.length) map.fitBounds(bounds);
    }

    // --- 6. PDF åŒ¯å‡º ---
    async function downloadItinerary() {
        const element = document.getElementById('chat-messages');
        const opt = { margin: 10, filename: 'TravelPlan.pdf', html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4' } };
        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>
