<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£ AI æ™ºæ…§å°è¦½ç³»çµ± (Gemini é©…å‹•)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f8f9fa; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; }
        
        /* UI ä½ˆå±€ */
        header { background: var(--primary); color: white; padding: 15px; text-align: center; }
        .config-bar { background: #fff; padding: 10px 20px; display: flex; gap: 10px; border-bottom: 1px solid #ddd; }
        .config-bar input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.8rem; }

        .main-container { display: grid; grid-template-columns: 350px 1fr 300px; gap: 10px; padding: 10px; flex: 1; overflow: hidden; }

        /* å´æ¬„èˆ‡å¡ç‰‡ */
        .sidebar { overflow-y: auto; }
        .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; border-left: 4px solid transparent; }
        .card:hover { border-left: 4px solid var(--accent); }
        .weather-info { background: #e3f2fd; padding: 8px; border-radius: 5px; margin: 10px 0; font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between; }

        /* åœ°åœ–å€ */
        #map { height: 100%; border-radius: 8px; }

        /* AI å›æ‡‰å€ */
        .ai-panel { background: white; padding: 15px; border-radius: 8px; overflow-y: auto; display: flex; flex-direction: column; border: 1px solid #eee; }
        .ai-content { font-size: 0.95rem; line-height: 1.6; color: #444; white-space: pre-line; }
        .loading { color: #888; font-style: italic; }

        .ai-btn { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; }
        .ai-btn:disabled { background: #ccc; }

        @media (max-width: 1024px) { .main-container { grid-template-columns: 1fr; } .ai-panel, .sidebar { height: 300px; } }
    </style>
</head>
<body>

<header>
    <h1>ğŸ‡¹ğŸ‡¼ å°ç£ AI æ™ºæ…§æ—…éŠå°è¦½ç³»çµ±</h1>
</header>

<div class="config-bar">
    <input type="password" id="weatherKey" placeholder="OpenWeather API Key">
    <input type="password" id="geminiKey" placeholder="Gemini API Key">
    <small>é‡‘é‘°åƒ…ä¿å­˜åœ¨ç€è¦½å™¨è¨˜æ†¶é«”ä¸­</small>
</div>

<div class="main-container">
    <aside class="sidebar">
        <div class="card" onclick="focusLocation(25.0339, 121.5644, 'å°åŒ— 101', 'weather-tp')">
            <h3>å°åŒ— 101</h3>
            <div id="weather-tp" class="weather-info">è«‹å…ˆæ›´æ–°å¤©æ°£...</div>
            <button class="ai-btn" onclick="getAIDuide('å°åŒ— 101', 'weather-tp')">AI å°è¦½å»ºè­°</button>
        </div>

        <div class="card" onclick="focusLocation(24.1632, 120.6489, 'å°ä¸­æ­ŒåŠ‡é™¢', 'weather-tc')">
            <h3>å°ä¸­åœ‹å®¶æ­ŒåŠ‡é™¢</h3>
            <div id="weather-tc" class="weather-info">è«‹å…ˆæ›´æ–°å¤©æ°£...</div>
            <button class="ai-btn" onclick="getAIDuide('å°ä¸­æ­ŒåŠ‡é™¢', 'weather-tc')">AI å°è¦½å»ºè­°</button>
        </div>

        <div class="card" onclick="focusLocation(22.6204, 120.2815, 'é«˜é›„é§äºŒ', 'weather-kh')">
            <h3>é«˜é›„é§äºŒç‰¹å€</h3>
            <div id="weather-kh" class="weather-info">è«‹å…ˆæ›´æ–°å¤©æ°£...</div>
            <button class="ai-btn" onclick="getAIDuide('é«˜é›„é§äºŒ', 'weather-kh')">AI å°è¦½å»ºè­°</button>
        </div>
        <button onclick="updateAllWeather()" style="width:100%; margin-top:10px;">â˜€ï¸ æ›´æ–°æ‰€æœ‰å¤©æ°£</button>
    </aside>

    <div id="map"></div>

    <section class="ai-panel">
        <h3>ğŸ¤– AI æ™ºæ…§å°è¦½å“¡</h3>
        <hr>
        <div id="ai-output" class="ai-content">é»æ“Šå·¦å´ã€ŒAI å°è¦½å»ºè­°ã€æŒ‰éˆ•ï¼ŒGemini å°‡æ ¹æ“šç›®å‰å¤©æ°£ç‚ºæ‚¨è¦åŠƒè¡Œç¨‹...</div>
    </section>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. åœ°åœ–åˆå§‹åŒ–
    const map = L.map('map').setView([23.6, 121.0], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const weatherDataStore = {}; // å„²å­˜å„åœ°çš„å¤©æ°£æ–‡å­—è³‡è¨Š

    // 2. ç²å–å¤©æ°£è³‡æ–™
    async function fetchWeather(lat, lon, elementId) {
        const apiKey = document.getElementById('weatherKey').value;
        if (!apiKey) return;

        try {
            const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=zh_tw`);
            const data = await response.json();
            const info = `${data.weather[0].description}ï¼Œæ°£æº« ${data.main.temp}Â°C`;
            document.getElementById(elementId).innerHTML = `<span>${info}</span><img src="https://openweathermap.org/img/wn/${data.weather[0].icon}.png" width="30">`;
            weatherDataStore[elementId] = info; // å­˜ä¸‹ä¾†çµ¦ AI ç”¨
        } catch (e) {
            document.getElementById(elementId).innerText = "å¤©æ°£ç²å–å¤±æ•—";
        }
    }

    function updateAllWeather() {
        fetchWeather(25.0339, 121.5644, 'weather-tp');
        fetchWeather(24.1632, 120.6489, 'weather-tc');
        fetchWeather(22.6204, 120.2815, 'weather-kh');
    }

    // 3. æ ¸å¿ƒåŠŸèƒ½ï¼šå°æ¥ Gemini API
    async function getAIDuide(locationName, weatherId) {
        const geminiKey = document.getElementById('geminiKey').value;
        const outputDiv = document.getElementById('ai-output');
        const weather = weatherDataStore[weatherId] || "æš«ç„¡å¤©æ°£è³‡è¨Š";

        if (!geminiKey) {
            alert("è«‹å…ˆè¼¸å…¥ Gemini API Key");
            return;
        }

        outputDiv.innerHTML = `<span class="loading">æ­£åœ¨è©¢å• Gemini å°è¦½å“¡... ğŸ’­</span>`;

        // å»ºç«‹ Prompt (æç¤ºè©)
        const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ç£æ—…éŠå°è¦½å“¡ã€‚ç›®å‰éŠå®¢è¨ˆç•«å‰å¾€ã€Œ${locationName}ã€ï¼Œç•¶åœ°çš„å³æ™‚å¤©æ°£æ˜¯ã€Œ${weather}ã€ã€‚è«‹æ ¹æ“šæ­¤å¤©æ°£ç‹€æ³ï¼Œæä¾›å¤§ç´„ 200 å­—çš„æ—…éŠå»ºè­°ï¼ŒåŒ…å«ï¼š1. é©åˆçš„ç©¿è‘— 2. æ¨è–¦çš„æ´»å‹•(è‹¥æ˜¯é›¨å¤©è«‹æ¨è–¦å‚™æ¡ˆ) 3. æ¨è–¦çš„ä¸€æ¨£é™„è¿‘ç¾é£Ÿã€‚è«‹ç”¨è¦ªåˆ‡å‹å–„çš„å£å»æ’°å¯«ã€‚`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            const aiText = data.candidates[0].content.parts[0].text;
            outputDiv.innerText = aiText;
        } catch (error) {
            outputDiv.innerText = "æŠ±æ­‰ï¼ŒAI å°è¦½æš«æ™‚ç„¡æ³•é€£ç·šã€‚è«‹æª¢æŸ¥æ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºã€‚";
            console.error(error);
        }
    }

    function focusLocation(lat, lng, name, weatherId) {
        map.flyTo([lat, lng], 15);
        L.marker([lat, lng]).addTo(map).bindPopup(name).openPopup();
    }
</script>
</body>
</html>
