<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°ç£æ™ºæ…§æ—…éŠå°è¦½ç³»çµ± (Gemini ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f8f9fa;
        }

        body, html {
            height: 100%;
            margin: 0;
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
            background-color: var(--bg);
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* å´é‚Šæ¬„ */
        .sidebar {
            width: 400px;
            background: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            z-index: 1000;
            overflow-y: auto;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        button:hover { background: #2980b9; }

        /* è¡Œç¨‹é¡¯ç¤ºå€æ¨£å¼ */
        #ai-output { margin-top: 20px; }

        .itinerary-item {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .spot-img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .spot-info {
            padding: 12px;
            border-left: 4px solid var(--accent);
        }

        /* åœ°åœ–å€ */
        #map { flex: 1; height: 100%; }

        .loading-spinner {
            color: var(--accent);
            font-weight: bold;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>ğŸ‡¹ğŸ‡¼ AI å°ç£æ™ºæ…§æ—…éŠå°è¦½ç³»çµ±</h1>
    </header>

    <div class="main-content">
        <div class="sidebar">
            <div class="input-group">
                <label>ğŸ”‘ Google AI (Gemini) API Key</label>
                <input type="password" id="api-key" placeholder="AIza...">
            </div>

            <div class="input-group">
                <label>ğŸ“ ç›®çš„åœ°åŸå¸‚</label>
                <select id="city">
                    <option value="å°åŒ—">å°åŒ—</option>
                    <option value="å°ä¸­">å°ä¸­</option>
                    <option value="å°å—">å°å—</option>
                    <option value="é«˜é›„">é«˜é›„</option>
                    <option value="å®œè˜­">å®œè˜­</option>
                    <option value="èŠ±è“®">èŠ±è“®</option>
                </select>
            </div>

            <div class="input-group">
                <label>ğŸ’¬ æ‚¨çš„æ—…éŠåå¥½æˆ–ä¿®æ”¹éœ€æ±‚</label>
                <textarea id="preference" rows="4" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³å»æ–‡é’å’–å•¡å»³ã€çœ‹å¤•é™½ï¼Œä¸è¦å¤ªç´¯çš„è¡Œç¨‹..."></textarea>
            </div>

            <button onclick="generatePlan()">ç”Ÿæˆ / ä¿®æ”¹ AI è¡Œç¨‹</button>
            <button onclick="resetChat()" style="background:#95a5a6;">é‡è¨­å°è©±</button>

            <div id="ai-output">
                <p style="color:#888; text-align:center;">è«‹è¼¸å…¥ API Key ä¸¦æè¿°éœ€æ±‚ä»¥é–‹å§‹è¦åŠƒã€‚</p>
            </div>
        </div>

        <div id="map"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let map;
    let markersLayer = L.layerGroup();
    let chatHistory = [];

    // åˆå§‹åŒ–åœ°åœ–
    window.onload = function() {
        map = L.map('map').setView([23.6, 121.0], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        markersLayer.addTo(map);
    };

    // è‡ªå‹•ç²å–åœ–ç‰‡ç¶²å€ (ä½¿ç”¨ Unsplash é—œéµå­—)
    function getPlaceImage(spotName) {
        return `https://images.unsplash.com/photo-1542314831-068cd1dbfeeb?auto=format&fit=crop&w=400&q=80&sig=${encodeURIComponent(spotName)}`;
        // æ³¨æ„ï¼šUnsplash Source æœå‹™æœ‰æ™‚è¼ƒæ…¢ï¼Œæ­¤è™•ä½¿ç”¨éš¨æ©Ÿæ•¸ sig æ¨¡æ“¬æœå°‹
    }

    async function generatePlan() {
    const apiKey = document.getElementById('api-key').value.trim();
    const city = document.getElementById('city').value;
    const pref = document.getElementById('preference').value;
    const output = document.getElementById('ai-output');

    if (!apiKey) {
        alert("è«‹è¼¸å…¥ Google AI API Keyï¼");
        return;
    }

    output.innerHTML = `<p class="loading-spinner">Gemini æ­£åœ¨è¦åŠƒä¸­... â³</p>`;

    // 1. åœ¨ Prompt ä¸­å†æ¬¡å¼·èª¿ JSONï¼Œä½œç‚ºé›™é‡ä¿éšª
    const systemInstruction = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ç£å°éŠã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚
    å¿…é ˆå›å‚³ JSON æ ¼å¼ï¼Œå…§å®¹åŒ…å«ï¼š
    {
      "itinerary": [
        { "time": "æ™‚é–“", "spot": "æ™¯é»åç¨±", "desc": "æè¿°", "lat": ç·¯åº¦æ•¸å­—, "lng": ç¶“åº¦æ•¸å­— }
      ],
      "note": "å»ºè­°"
    }`;

    if (chatHistory.length === 0) {
        chatHistory.push({ role: "user", parts: [{ text: `${systemInstruction}\nç›®çš„åœ°ï¼š${city}\néœ€æ±‚ï¼š${pref}` }] });
    } else {
        chatHistory.push({ role: "user", parts: [{ text: pref }] });
    }

    try {
        // --- ä½¿ç”¨ v1beta ç¶²å€ï¼Œé€™æ˜¯ç›®å‰æ”¯æ´ JSON Mode æœ€ç©©å®šçš„è·¯å¾‘ ---
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: chatHistory,
                generationConfig: {
                    // æ³¨æ„ï¼šåœ¨ v1beta ä¸­ï¼Œé€™å€‹æ¬„ä½æ˜¯ç”¨ä¾†å¼·åˆ¶è¼¸å‡ºçš„
                    responseMimeType: "application/json", 
                    temperature: 0.7
                }
            })
        });

        const data = await response.json();

        if (data.error) {
            // å¦‚æœé‚„æ˜¯å ±éŒ¯ï¼Œå˜—è©¦ç§»é™¤ responseMimeType å†ç™¼é€ä¸€æ¬¡ï¼ˆç›¸å®¹æ€§å¢Šç‰‡ï¼‰
            throw new Error(data.error.message);
        }

        const aiText = data.candidates[0].content.parts[0].text;
        chatHistory.push({ role: "model", parts: [{ text: aiText }] });
        
        renderResults(JSON.parse(aiText));
        document.getElementById('preference').value = "";

    } catch (error) {
        console.error(error);
        output.innerHTML = `<p style="color:red">ç³»çµ±ç•°å¸¸ï¼š${error.message}<br><small>æç¤ºï¼šè«‹ç¢ºèª API Key æ˜¯å¦æ­£ç¢ºä¸”å…·å‚™ Gemini 1.5 æ¬Šé™ã€‚</small></p>`;
    }
}

    function renderResults(data) {
        const output = document.getElementById('ai-output');
        let html = `<h3>âœ… å»ºè­°è¡Œç¨‹ï¼š</h3>`;
        const latlngs = [];
        markersLayer.clearLayers();

        data.itinerary.forEach((item, index) => {
            // ä½¿ç”¨å‹•æ…‹åœ–ç‰‡ (åŠ ä¸Š Taiwan é—œéµå­—æé«˜ç²¾æº–åº¦)
            const imgUrl = `https://loremflickr.com/400/250/Taiwan,${encodeURIComponent(item.spot)}/all`;

            html += `
                <div class="itinerary-item">
                    <img src="${imgUrl}" class="spot-img" alt="${item.spot}">
                    <div class="spot-info">
                        <strong>${index + 1}. ${item.time} - ${item.spot}</strong><br>
                        <small>${item.desc}</small>
                    </div>
                </div>`;

            if (item.lat && item.lng) {
                const marker = L.marker([item.lat, item.lng])
                    .bindPopup(`<img src="${imgUrl}" style="width:100%"><br><b>${item.spot}</b>`);
                markersLayer.addLayer(marker);
                latlngs.push([item.lat, item.lng]);
            }
        });

        html += `<p style="font-size:0.85rem; padding:10px; background:#fff;">ğŸ’¡ ${data.note || ""}</p>`;
        output.innerHTML = html;

        if (latlngs.length > 0) {
            map.fitBounds(L.latLngBounds(latlngs), { padding: [50, 50] });
        }
    }

    function resetChat() {
        chatHistory = [];
        markersLayer.clearLayers();
        document.getElementById('ai-output').innerHTML = "è¡Œç¨‹å·²é‡è¨­ã€‚";
        map.setView([23.6, 121.0], 7);
    }
</script>

</body>
</html>
