<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°ç£æ™ºæ…§æ—…éŠè¡Œç¨‹è¦ç•«ç³»çµ±</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --sidebar-width: 350px;
        }

        body {
            font-family: "Microsoft JhengHei", system-ui, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f8f9fa;
        }

        /* æ¨™é¡Œå€ */
        header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* å´é‚Šæ¬„ï¼šè¨­å®šèˆ‡ API å€ */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section-title {
            font-weight: bold;
            color: var(--primary);
            border-left: 4px solid var(--accent);
            padding-left: 10px;
            margin-bottom: 10px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label { font-size: 0.9rem; font-weight: 600; }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        button:hover { background: #219150; }

        /* åœ°åœ–å±•ç¤ºå€ */
        #map-wrapper {
            flex: 1;
            position: relative;
        }

        #map { height: 100%; width: 100%; }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-bar {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 30px;
            font-size: 0.85rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #ddd;
        }

        /* è¡Œç¨‹çµæœå¡ç‰‡ */
        #itinerary-result {
            margin-top: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .day-block {
            background: #f1f8f4;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸ‡¹ğŸ‡¼ AI å°ç£æ™ºæ…§æ—…éŠè¡Œç¨‹è¦ç•«</h1>
</header>

<div class="main-container">
    <aside class="sidebar">
        <div class="input-group">
            <div class="section-title">API é©—è­‰</div>
            <label for="api-key">Gemini API Key</label>
            <input type="password" id="api-key" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API é‡‘é‘°">
        </div>

        <div class="input-group">
            <div class="section-title">è¡Œç¨‹è¨­å®š</div>
            <label for="destination">ç›®çš„åœ°</label>
            <select id="destination">
                <option value="[25.0330, 121.5654]">å°åŒ—å¸‚</option>
                <option value="[24.1477, 120.6736]">å°ä¸­å¸‚</option>
                <option value="[22.9997, 120.2270]">å°å—å¸‚</option>
                <option value="[22.6273, 120.3014]">é«˜é›„å¸‚</option>
                <option value="[23.9771, 121.6044]">èŠ±è“®ç¸£</option>
            </select>
        </div>

        <div class="input-group">
            <label for="days">æ—…éŠå¤©æ•¸</label>
            <input type="number" id="days" value="2" min="1" max="5">
        </div>

        <div class="input-group">
            <label for="style">æ—…éŠé¢¨æ ¼</label>
            <select id="style">
                <option value="ç¾é£Ÿèˆ‡åœ¨åœ°å°åƒ">ç¾é£Ÿåƒè²¨</option>
                <option value="è‡ªç„¶èˆ‡ç™»å±±å¥è¡Œ">è‡ªç„¶å±±æµ·</option>
                <option value="æ­·å²å»ºç¯‰èˆ‡æ–‡é’è¡—å€">æ–‡é’å¤è¹Ÿ</option>
            </select>
        </div>

        <button onclick="startPlanning()">é–‹å§‹ AI æ™ºæ…§è¦åŠƒ</button>

        <div id="itinerary-result"></div>
    </aside>

    <main id="map-wrapper">
        <div id="map"></div>
        <div class="status-bar" id="status-text">ç³»çµ±ç‹€æ…‹ï¼šæº–å‚™å°±ç·’</div>
    </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // 1. åˆå§‹åŒ–åœ°åœ–
    const map = L.map('map').setView([25.0330, 121.5654], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const routeLayer = L.featureGroup().addTo(map);

    // 2. ä¸»ç¨‹å¼é‚è¼¯
    async function startPlanning() {
        const apiKey = document.getElementById('api-key').value.trim();
        const status = document.getElementById('status-text');
        
        if (!apiKey) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Gemini API Key");
            return;
        }

        status.innerText = "â³ æ­£åœ¨é©—è­‰ Key ä¸¦è¦åŠƒè¡Œç¨‹...";
        status.style.color = "#d68910";

        try {
            const planData = await fetchGeminiAI(apiKey);
            renderRoute(planData);
            status.innerText = "âœ… è¡Œç¨‹è¦åŠƒå®Œæˆï¼";
            status.style.color = "green";
        } catch (error) {
            console.error(error);
            status.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯";
            status.style.color = "red";
            alert("éŒ¯èª¤: " + error.message);
        }
    }

    // 3. ä¸²æ¥ Gemini API
    async function fetchGeminiAI(apiKey) {
        const destName = document.getElementById('destination').selectedOptions[0].text;
        const days = document.getElementById('days').value;
        const style = document.getElementById('style').value;

        const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ç£æ—…éŠè¦åŠƒå¸«ã€‚è«‹è¦åŠƒ ${destName} çš„ ${days} å¤©æ—…éŠè¡Œç¨‹ï¼Œé¢¨æ ¼ç‚º ${style}ã€‚
        è«‹å›å‚³ JSON æ ¼å¼é™£åˆ—ï¼Œä¸è¦æœ‰ä»»ä½• Markdown æ¨™ç±¤æˆ–å…¶ä»–èªªæ˜æ–‡å­—ã€‚
        æ ¼å¼ï¼š[{"day": 1, "order": 1, "name": "æ™¯é»", "lat": 25.1, "lng": 121.5, "desc": "æè¿°"}]
        è«‹ç¢ºä¿ç·¯åº¦(lat)èˆ‡ç¶“åº¦(lng)æ˜¯ç²¾ç¢ºçš„æ•¸å­—ã€‚`;

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
            })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error.message);

        const rawText = data.candidates[0].content.parts[0].text;
        const cleanJson = rawText.replace(/```json|```/g, "").trim();
        return JSON.parse(cleanJson);
    }

    // 4. åœ°åœ–æ¸²æŸ“èˆ‡é€£ç·š
    function renderRoute(spots) {
        routeLayer.clearLayers();
        const resultDiv = document.getElementById('itinerary-result');
        resultDiv.innerHTML = "<h3>ğŸ“… AI æ¨è–¦è¡Œç¨‹</h3>";

        const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6'];
        const daysMap = {};

        // åˆ†é¡å¤©æ•¸
        spots.forEach(s => {
            if (!daysMap[s.day]) daysMap[s.day] = [];
            daysMap[s.day].push(s);
        });

        Object.keys(daysMap).forEach((day, index) => {
            const daySpots = daysMap[day].sort((a, b) => a.order - b.order);
            const color = colors[index % colors.length];
            const polylineCoords = [];

            const dayEl = document.createElement('div');
            dayEl.className = 'day-block';
            dayEl.innerHTML = `<strong style="color:${color}">ç¬¬ ${day} å¤©</strong><br>`;

            daySpots.forEach(spot => {
                polylineCoords.push([spot.lat, spot.lng]);
                
                // åœ°åœ–æ¨™è¨˜
                L.marker([spot.lat, spot.lng])
                    .bindPopup(`<b>D${day}-${spot.order}: ${spot.name}</b><br>${spot.desc}`)
                    .addTo(routeLayer);
                
                dayEl.innerHTML += `${spot.order}. ${spot.name}<br>`;
            });

            // ç•«å‡ºé€£ç·š
            L.polyline(polylineCoords, {
                color: color,
                weight: 4,
                opacity: 0.6,
                dashArray: '8, 8'
            }).addTo(routeLayer);

            resultDiv.appendChild(dayEl);
        });

        // èª¿æ•´è¦–é‡
        map.fitBounds(routeLayer.getBounds().pad(0.1));
    }
</script>

</body>
</html>
