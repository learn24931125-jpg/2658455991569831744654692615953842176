<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>AI æ—…éŠåŠ©ç† - ç©©å®šç‰ˆ (å«é›¨å¤©å‚™æ¡ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --rain: #607d8b; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #fdfdfd; }
        header { background: var(--primary); color: white; padding: 15px; text-align: center; }
        .main-ui { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 380px; padding: 20px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); overflow-y: auto; }
        input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; }
        .trip-card { border-left: 5px solid var(--accent); background: #f9f9f9; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .rain-alert { background: #e1f5fe; border-left-color: var(--rain); }
        .weather-chip { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; background: #eee; margin-top: 5px; }
        #map { flex: 1; }
    </style>
</head>
<body>

<header>ğŸŒ¤ï¸ AI é¿é›¨å°èˆªåŠ©ç† (Gemini 1.5 Flash ç©©å®šç‰ˆ)</header>

<div class="main-ui">
    <aside id="sidebar">
        <label><b>API Key</b></label>
        <input type="password" id="api-key" placeholder="è²¼ä¸Šæ‚¨çš„ API Key">
        <label><b>ç›®çš„åœ°èˆ‡æ™‚é–“</b></label>
        <input type="text" id="user-prompt" placeholder="ä¾‹å¦‚ï¼šæ˜å¤©å»é™½æ˜å±±ç©" value="æœ¬é€±æœ«å»å®œè˜­ç©">
        <button onclick="smartPlan()">ğŸš€ è¦åŠƒé¿é›¨è¡Œç¨‹</button>
        <div id="status" style="font-size: 0.85rem; color: #666; margin: 10px 0;">ç³»çµ±å°±ç·’</div>
        <div id="itinerary-list"></div>
    </aside>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    const map = L.map('map').setView([23.6, 121.0], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let routingControl = null;

    // å¤©æ°£è½‰æ›
    const weatherIcon = (code) => {
        if ([0, 1].includes(code)) return "â˜€ï¸ æ™´æœ—";
        if ([2, 3].includes(code)) return "â˜ï¸ é™°å¤©";
        if ([51, 61, 80, 95].includes(code)) return "ğŸŒ§ï¸ é›¨å¤©(éœ€å‚™æ¡ˆ)";
        return "â›… å¤šé›²";
    };

    async function smartPlan() {
        const key = document.getElementById('api-key').value.trim();
        const prompt = document.getElementById('user-prompt').value.trim();
        const status = document.getElementById('status');
        const listContainer = document.getElementById('itinerary-list');

        if (!key) return alert("è«‹è¼¸å…¥ API Key");
        
        status.innerHTML = "ğŸ“¡ æ­£åœ¨ç¢ºèªç›®çš„åœ°å¤©æ°£é å ±...";
        listContainer.innerHTML = "";

        try {
            // 1. é æŠ“åœ°å€åº§æ¨™ (ä»¥ç›®çš„åœ°ä¸­å¿ƒé»ç‚ºä¾‹)
            const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(prompt)}&format=json&limit=1`);
            const geoData = await geoRes.json();
            const lat = geoData[0]?.lat || 25.03;
            const lng = geoData[0]?.lon || 121.56;

            // 2. ç²å–æœªä¾† 7 å¤©å¤©æ°£ (Open-Meteo)
            const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max&timezone=auto`);
            const weatherData = await weatherRes.json();
            const todayIndex = 0; // ç°¡åŒ–ï¼šå…ˆçœ‹ä»Šæ—¥/æ˜æ—¥
            const isRaining = [51, 61, 80, 95].includes(weatherData.daily.weathercode[todayIndex]);

            status.innerHTML = `ğŸŒ¡ï¸ ç•¶åœ°é å ±ï¼š${weatherIcon(weatherData.daily.weathercode[todayIndex])}ã€‚æ­£åœ¨ç”± AI èª¿æ•´è¡Œç¨‹...`;

            // 3. å‘¼å« Gemini (ä½¿ç”¨æœ€æ–°è·¯å¾‘æ ¼å¼é¿å… 404)
            // ä¿®æ­£è·¯å¾‘ï¼šä½¿ç”¨ models/gemini-1.5-flash-latest
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${key}`;
            
            const sysMsg = `ä½ æ˜¯ä¸€ä½å°éŠã€‚è«‹è¦åŠƒ3å€‹æ™¯é»ã€‚
            æ³¨æ„ï¼šç•¶åœ°é å ±ç‚º ${isRaining ? 'é›¨å¤©' : 'æ™´å¤©'}ã€‚
            ${isRaining ? 'è«‹ã€Œå‹™å¿…ã€æ¨è–¦å®¤å…§æ™¯é»ã€åšç‰©é¤¨æˆ–è§€å…‰å·¥å» ä½œç‚ºé›¨å¤©å‚™æ¡ˆã€‚' : 'è«‹æ¨è–¦æˆ¶å¤–è‡ªç„¶æ™¯é»ç‚ºä¸»ã€‚'}
            åš´æ ¼å›å‚³JSONé™£åˆ—ï¼š[{"name":"åç¨±","type":"indoor|outdoor","lat":25.0,"lng":121.0,"desc":"ä»‹ç´¹"}]`;

            const aiRes = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: `${sysMsg}\néœ€æ±‚ï¼š${prompt}` }] }] })
            });

            const aiData = await aiRes.json();
            if (!aiRes.ok) throw new Error(aiData.error.message);

            const locations = JSON.parse(aiData.candidates[0].content.parts[0].text.match(/\[[\s\S]*\]/)[0]);

            // 4. æ¸²æŸ“çµæœ
            locations.forEach(loc => {
                const card = document.createElement('div');
                card.className = `trip-card ${isRaining && loc.type === 'indoor' ? 'rain-alert' : ''}`;
                card.innerHTML = `
                    <strong>${loc.name}</strong> [${loc.type === 'indoor' ? 'å®¤å…§' : 'æˆ¶å¤–'}]<br>
                    <small>${loc.desc}</small><br>
                    <div class="weather-chip">ç•¶åœ°é æ¸¬ï¼š${weatherIcon(weatherData.daily.weathercode[todayIndex])}</div>
                `;
                listContainer.appendChild(card);
            });

            renderRoute(locations);
            status.innerHTML = `âœ… å·²æ ¹æ“šå¤©æ°£å®Œæˆè¦åŠƒ (${isRaining ? 'å·²å•Ÿå‹•é›¨å¤©å‚™æ¡ˆ' : 'æˆ¶å¤–è¡Œç¨‹'})`;

        } catch (e) {
            status.innerHTML = `âŒ ç³»çµ±éŒ¯èª¤ï¼š${e.message}`;
            console.error(e);
        }
    }

    function renderRoute(locations) {
        if (routingControl) map.removeControl(routingControl);
        const wps = locations.map(l => L.latLng(l.lat, l.lng));
        routingControl = L.Routing.control({
            waypoints: wps,
            createMarker: (i, wp) => L.marker(wp.latLng).bindPopup(locations[i].name)
        }).addTo(map);
        map.fitBounds(L.latLngBounds(wps), { padding: [50, 50] });
    }
</script>
</body>
</html>
